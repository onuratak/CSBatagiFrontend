<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS2 Stats Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="table-styles.css">
    <style>
        /* Use Inter font */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            color: #1f2937; /* Darker gray text */
        }

        /* --- General Styles --- */
        /* Hide inactive page content */
        .page-content.hidden {
            display: none;
        }
        /* Ensure hidden class works */
        .hidden {
           display: none !important; /* Use important to override potential inline styles if needed */
        }

        /* Simple spinner (used for button) */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            width: 20px;
            height: 20px;
            animation: spin 1s ease-in-out infinite;
            display: inline-block;
            margin-left: 10px;
            vertical-align: middle;
        }

        /* Wheel spinner (SVG Container - for "Teker Döndü") */
        .wheel-spinner {
            display: inline-block;
            width: 30px; /* Adjust size as needed */
            height: 30px;
            /* Removed border properties */
            animation: spin 8s linear infinite; /* Apply spin animation, maybe slightly slower */
            vertical-align: middle; /* Align with text */
            margin-left: 0.5rem; /* Add some space */
            /* Color is now set dynamically via JS */
            /* color: #4b5563; */ /* Default color removed */
        }
        /* Ensure SVG inside fills the container */
        .wheel-spinner svg {
             width: 100%;
             height: 100%;
        }


        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* --- Table Styles (Desktop Default) --- */
        th, td {
            /* Default padding for desktop view */
            padding: 12px 16px; /* Equivalent to py-3 px-4 */
            text-align: left;
            vertical-align: middle;
            /* border-bottom will be handled by Tailwind on the table/tbody or specific rules */
        }
        /* Header specific styles (if needed beyond default th, td) */
        th {
             font-weight: 600;
        }

        /* Rules from table-styles.css will override these for tables with .styled-table class */

        /* --- Status Badge Style (Keep for non-table badges if needed) --- */
        /* Status badge styles are now in table-styles.css */

        /* --- Responsive adjustments for mobile (max-width: 640px) --- */
        @media (max-width: 640px) {
            /* Mobile styles are now in table-styles.css */
        }

        /* --- Info Panel Styles (Light Theme) --- */
        /* Info panel styles are now in table-styles.css */

        /* --- Tab Navigation Styles (Light Theme) --- */
        .tab-nav-item { /* Base style for ALL nav items */
            padding: 0.75rem 1rem; /* Default padding */
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            color: #6b7280; /* Default tab color (gray) */
            font-weight: 500;
            white-space: nowrap; /* Prevent wrapping */
            display: inline-block; /* Ensure proper spacing and border */
            border-radius: 0.375rem 0.375rem 0 0; /* Add top rounding */
        }
        .tab-nav-item:hover:not(.active) { /* Hover for NON-MAP tabs */
            color: #1f2937; /* Darker color on hover */
            /* background-color: #f9fafb; */ /* Removed general hover background */
        }
        .tab-nav-item.active { /* Style for ANY active tab */
            color: #1e40af; /* Darker blue text for better contrast */
            border-bottom-color: #2563eb; /* Active tab border color */
            font-weight: 600;
            background-color: #eff6ff; /* Light blue background (blue-50) */
        }

        /* Specific styles for SonMac map tabs */
        .map-tab-button {
             background-color: #f3f4f6; /* Default light gray background */
        }
        .map-tab-button:hover:not(.active) {
            color: #1f2937; /* Darker text on hover */
            background-color: #e5e7eb; /* Slightly darker gray background on hover */
        }
        /* The .tab-nav-item.active style above will handle the active state */

        /* --- Mobile Navigation Styles --- */
        /* Container when mobile menu is active */
        #main-nav-links.mobile-menu-active {
            display: flex;
            flex-direction: column;
            position: absolute;
            top: 100%; /* Position below the header */
            left: 0;
            right: 0;
            background-color: white;
            z-index: 30; /* Increased z-index from 20 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            border-radius: 0 0 0.375rem 0.375rem; /* rounded-b-md */
        }
        /* Individual links in mobile menu */
        #main-nav-links.mobile-menu-active .tab-nav-item {
            display: block; /* Make links block level */
            padding: 0.75rem 1rem; /* Consistent padding */
            border-bottom: 1px solid #e5e7eb; /* Separator */
            border-left: 3px solid transparent; /* For active state indicator */
            border-bottom-color: #e5e7eb; /* Override bottom border from desktop */
            color: #374151; /* Default text color */
            font-weight: 500;
        }
        #main-nav-links.mobile-menu-active .tab-nav-item:last-child {
            border-bottom: none; /* Remove border from last item */
        }
        /* Active link style in mobile menu */
        #main-nav-links.mobile-menu-active .tab-nav-item.active {
            color: #2563eb; /* Active tab color (blue) */
            border-left-color: #2563eb; /* Active tab border color */
            background-color: #eff6ff; /* Light blue background (blue-50) */
            border-bottom-color: #e5e7eb !important; /* Ensure bottom border remains consistent */
            font-weight: 600;
        }

        /* --- Basic Button Style (Light Theme) --- */
        .action-button {
            background-color: #2563eb; /* Blue */
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 0.375rem; /* rounded-md */
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-weight: 500;
            display: inline-flex; /* Align spinner correctly */
            align-items: center;
            justify-content: center;
        }
        .action-button:hover {
            background-color: #1d4ed8; /* Darker Blue */
        }
        .action-button:disabled {
            background-color: #9ca3af; /* Gray when disabled */
            cursor: not-allowed;
        }
        .action-button:focus {
             outline: 2px solid transparent;
             outline-offset: 2px;
             box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.5); /* Ring focus */
        }


        /* --- Message Area (Light Theme) --- */
        #message-area {
            margin-top: 1rem;
            padding: 0.75rem 1.25rem;
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 500;
            border-width: 1px;
            border-style: solid;
            max-width: 42rem; /* max-w-lg */
            margin-left: auto;
            margin-right: auto;
            text-align: center;
        }
        #message-area.success {
            background-color: #dcfce7; color: #166534; border-color: #86efac; /* Green */
        }
        #message-area.error {
            background-color: #fee2e2; color: #991b1b; border-color: #fca5a5; /* Red */
        }

        /* --- General Page Content Container Style --- */
        .page-content-container {
            background-color: #ffffff;
            padding: 1.5rem; /* p-6 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); /* shadow-sm */
            border: 1px solid #e5e7eb; /* border-gray-200 */
        }

        /* --- Attendance Control Styles --- */
        /* Attendance control styles are now in table-styles.css */

        /* --- Player Status Table Styles --- */
        /* Player status table styles are now in table-styles.css */

        /* --- Duello Son Maç Grid Styles --- */
        /* Updated with table-specific styles */
        #duello-table {
            border-collapse: separate;
            border-spacing: 0;
            min-width: 1200px;
            width: auto;
            border: 1px solid #e5e7eb;
            background-color: white;
        }
        
        #duello-grid-container {
            max-width: 100%;
            overflow-x: auto;
            max-height: 75vh;
            overflow-y: auto;
            border-radius: 0.375rem;
            background-color: white;
            border: 1px solid #e5e7eb;
        }
        
        /* Fix for sticky headers in webkit browsers */
        #duello-table thead th {
            position: -webkit-sticky; /* Safari */
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #f9fafb;
        }
        
        /* Fix for sticky first column */
        #duello-table th:first-child {
            position: -webkit-sticky; /* Safari */
            position: sticky;
            left: 0;
            z-index: 10;
            background-color: #f9fafb;
        }
        
        /* Fix for sticky corner */
        #duello-table thead th:first-child {
            position: -webkit-sticky; /* Safari */
            position: sticky;
            left: 0;
            top: 0;
            z-index: 20; /* Above other sticky elements */
            background-color: #f9fafb;
        }
        
        /* Border styling for cells */
        #duello-table th, 
        #duello-table td {
            border: 1px solid #e5e7eb;
        }
        
        /* Fix for last table elements border radius */
        #duello-table tr:last-child td:first-child {
            border-bottom-left-radius: 0.375rem;
        }
        
        #duello-table tr:last-child td:last-child {
            border-bottom-right-radius: 0.375rem;
        }

        .duello-header-cell {
            background-color: #f9fafb; /* bg-gray-50 */
            font-weight: 600; /* font-semibold */
            padding: 0.75rem; /* p-3 */
            text-align: center;
            vertical-align: middle;
            border: 1px solid #e5e7eb; /* border-gray-200 */
            position: relative;
        }
        
        /* Make first column sticky on horizontal scroll */
        #duello-table th:first-child {
            position: sticky;
            left: 0;
            z-index: 10;
            background-color: #f9fafb; /* Match header background */
            box-shadow: 2px 0 5px -2px rgba(0,0,0,0.1); /* Subtle shadow to indicate stickiness */
        }

        .duello-data-cell {
            padding: 0.5rem; /* p-2 */
            border: 1px solid #e5e7eb; /* border-gray-200 */
            text-align: center;
            min-height: 50px; /* Ensure cells have some height */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative; /* For potential future additions like tooltips */
        }

        /* Specific styling for kill/death numbers */
        .duello-kill {
            color: #16a34a; /* text-green-600 */
            font-weight: 700; /* font-bold */
            font-size: 1.125rem; /* text-lg */
            line-height: 1.2; /* Adjust line height for tighter packing */
        }

        .duello-death {
            color: #dc2626; /* text-red-600 */
            font-weight: 700; /* font-bold */
            font-size: 1.125rem; /* text-lg */
            line-height: 1.2; /* Adjust line height for tighter packing */
        }

        /* Style for the diagonal (self vs self) cells */
        .duello-data-cell.bg-gray-100 {
            background-color: #f3f4f6; /* bg-gray-100 */
        }

        /* Style for empty/zero cells */
        .duello-data-cell.text-gray-400 {
            color: #9ca3af; /* text-gray-400 */
            font-size: 1.25rem; /* text-xl */
        }

        /* Ensure grid container handles overflow */
        #duello-grid-container {
           max-width: 100%;
           overflow-x: auto; /* Enable horizontal scrolling */
           max-height: 75vh; /* Limit height to 75% of viewport height */
           overflow-y: auto; /* Enable vertical scrolling */
           padding-bottom: 1rem; /* Add padding for scrollbar */
           display: block; /* Ensure the container is block-level */
           position: relative; /* Position context for absolute elements if needed */
        }

        /* Styles for the grid itself (mostly set by JS, but can refine here) */
        #duello-grid {
            min-width: 1200px; /* Force a minimum width to ensure container scrolls */
            width: auto; /* Let the grid expand naturally based on its content */
            box-sizing: border-box; /* Include padding and border in the element's width and height */
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="container mx-auto max-w-7xl"> <header class="relative mb-6">
            <div class="flex justify-between items-center border-b border-gray-300 pb-3">
                <div class="flex items-center">
                    <img src="images/BatakLogo.png"
                         alt="Gaming Group Logo"
                         class="h-10 w-10 mr-2 object-contain"
                         onerror="this.onerror=null; this.src='https://placehold.co/40x40/e0e0e0/333?text=Logo';">
                    <h1 class="text-2xl md:text-3xl font-bold text-blue-700">CS Batağı Gururla Sunar</h1>
                </div>
                <button id="menu-button" type="button" class="md:hidden p-2 inline-flex items-center justify-center rounded-md text-gray-500 hover:text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500" aria-controls="main-nav-links" aria-expanded="false">
                    <span class="sr-only">Open main menu</span>
                    <svg id="icon-hamburger" class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                    <svg id="icon-close" class="hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <nav id="main-nav-links" class="sm:hidden md:flex md:flex-wrap md:items-center md:border-b md:border-gray-300 md:-mb-px md:mt-2" aria-label="Main navigation">
        <a class="tab-nav-item" data-page="attendance" href="#">Attendance</a>
        <a class="tab-nav-item" data-page="batak_domination" href="#">Batak Domination</a>
        <a class="tab-nav-item" data-page="sonmac" href="#">Son Maç</a>
        <a class="tab-nav-item" data-page="gece_ortalama" href="#">Gece Ortalaması</a>
        <a class="tab-nav-item" data-page="last10" href="#">Son 10 Ortalaması</a>
        <a class="tab-nav-item" data-page="season_avg" href="#">Sezon Ortalaması</a>
        <a class="tab-nav-item" data-page="duello_son_mac" href="#">Düello Son Maç</a>
    </nav>
        </header>

        <div id="message-area" class="hidden" role="alert" aria-live="polite"></div>

        <div id="page-content-area">

            <div id="page-attendance" class="page-content">
                <div class="text-center mb-6">
                    <button id="update-stats-button" class="action-button">
                        Update Attendance from Sheet
                        <span id="spinner" class="spinner hidden"></span>
                    </button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8">
                    <div class="lg:col-span-2 page-content-container overflow-x-auto"> <h2 class="text-2xl font-semibold mb-1 text-blue-600">Player Status</h2>
                        <div id="attendance-summary" class="text-lg font-semibold mb-4 flex items-center justify-center text-center px-4 py-2 rounded-md transition-colors duration-300">
                            <span id="summary-text">Loading summary...</span>
                            <span id="teker-dondu-indicator" class="wheel-spinner hidden" title="Teker Döndü!">
                                <svg 
                                height="40px" width="40px" version="1.1" id="_x32_" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" xml:space="preserve" fill="#000000"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <style type="text/css"> .st0{fill:#000000;} </style> <g> <path class="st0" d="M498.842,256c0-1.092-0.065-2.169-0.08-3.277c4.418-1.182,8.836-2.436,13.238-3.739 c-0.348-12.057-1.489-24.098-3.52-36.002c-4.556-0.445-9.136-0.809-13.708-1.124c-3.318-18.046-8.594-35.411-15.666-51.838 c3.609-2.768,7.186-5.632,10.762-8.529c-4.96-11.013-10.657-21.687-17.099-31.882c-4.369,1.343-8.731,2.767-13.085,4.232 c-9.913-15.253-21.476-29.318-34.463-41.941c2.274-3.965,4.636-7.858,6.821-11.896c-8.764-8.286-18.11-15.949-27.934-22.957 c-3.544,2.929-6.886,6.004-10.325,8.999c-14.841-10.254-30.904-18.871-47.889-25.628c0.599-4.548,1.125-9.112,1.594-13.676 c-11.272-4.322-22.884-7.818-34.65-10.504c-2.153,4.079-4.224,8.133-6.24,12.219c-16.33-3.456-33.25-5.308-50.599-5.308 c-1.158,0-2.29,0.065-3.447,0.097C251.355,8.82,250.279,4.394,248.968,0c-12.041,0.348-24.082,1.489-35.985,3.52 c-0.445,4.564-0.81,9.127-1.125,13.708c-18.069,3.318-35.41,8.594-51.837,15.65c-2.792-3.601-5.632-7.178-8.529-10.746 c-11.013,4.952-21.678,10.649-31.883,17.099c1.343,4.369,2.768,8.731,4.232,13.085C108.596,62.22,94.516,73.792,81.9,86.779 c-3.965-2.282-7.857-4.653-11.895-6.821c-8.286,8.755-15.949,18.102-22.957,27.934c2.921,3.544,6.004,6.894,8.998,10.342 c-10.252,14.841-18.87,30.871-25.635,47.864c-4.54-0.574-9.096-1.108-13.652-1.578c-4.337,11.297-7.833,22.876-10.52,34.634 c4.078,2.152,8.14,4.232,12.227,6.247c-3.464,16.33-5.316,33.25-5.316,50.599c0,1.092,0.064,2.193,0.072,3.277 c-4.402,1.182-8.828,2.428-13.222,3.754c0.348,12.033,1.482,24.074,3.513,35.977c4.556,0.438,9.135,0.818,13.715,1.134 c3.318,18.045,8.594,35.41,15.65,51.837c-3.601,2.776-7.17,5.624-10.746,8.521c4.944,11.03,10.641,21.695,17.098,31.891 c4.37-1.336,8.731-2.744,13.069-4.233c9.92,15.27,21.492,29.302,34.48,41.942c-2.282,3.965-4.653,7.848-6.821,11.878 c8.747,8.303,18.101,15.974,27.934,22.974c3.544-2.937,6.886-6.012,10.325-9.006c14.841,10.252,30.888,18.878,47.881,25.643 c-0.591,4.556-1.134,9.112-1.586,13.676c11.272,4.322,22.876,7.809,34.65,10.496c2.136-4.078,4.224-8.149,6.238-12.227 c16.33,3.464,33.25,5.309,50.6,5.309c1.157,0,2.29-0.065,3.439-0.073c1.206,4.402,2.266,8.828,3.577,13.23 c12.041-0.347,24.09-1.481,35.985-3.512c0.445-4.564,0.825-9.136,1.141-13.716c18.046-3.317,35.412-8.577,51.838-15.666 c2.768,3.617,5.616,7.186,8.512,10.762c11.03-4.944,21.687-10.648,31.899-17.098c-1.335-4.362-2.743-8.731-4.232-13.085 c15.245-9.913,29.326-21.469,41.941-34.464c3.965,2.29,7.85,4.644,11.888,6.821c8.294-8.764,15.965-18.101,22.957-27.934 c-2.937-3.544-5.996-6.886-8.99-10.326c10.252-14.841,18.846-30.895,25.636-47.889c4.556,0.599,9.112,1.117,13.667,1.57 c4.321-11.248,7.801-22.86,10.504-34.626c-4.079-2.136-8.149-4.224-12.228-6.238C496.998,290.27,498.842,273.357,498.842,256z M256,410.793c-85.501,0-154.809-69.292-154.809-154.793c0-85.5,69.308-154.8,154.809-154.8c85.484,0,154.809,69.3,154.809,154.8 C410.809,341.501,341.485,410.793,256,410.793z"></path> <path class="st0" d="M256,270.962c8.262,0,14.962-6.692,14.962-14.962c0-8.27-6.7-14.97-14.962-14.97 c-8.278,0-14.978,6.7-14.978,14.97C241.022,264.27,247.722,270.962,256,270.962z"></path> <path class="st0" d="M156.136,199.687c1.044,2.808,3.31,4.977,6.15,5.907l53.367,17.342c4.968,1.602,10.406,0.752,14.623-2.323 c4.232-3.075,6.724-7.979,6.724-13.206v-56.062c0-2.994-1.376-5.826-3.714-7.671c-2.347-1.861-5.406-2.541-8.327-1.861 c0,0,0.802-0.606-4.588,1.085c-25.191,7.938-46.756,24.042-61.572,45.218c-3.035,4.354-1.861,3.107-1.861,3.107 C155.384,193.772,155.092,196.887,156.136,199.687z"></path> <path class="st0" d="M214.391,269.53c-1.61-4.977-5.51-8.877-10.463-10.479l-53.327-17.325c-2.865-0.931-5.956-0.494-8.448,1.157 c-2.5,1.659-4.094,4.369-4.329,7.347c0,0-0.34-0.946-0.388,4.71c-0.251,26.396,8.407,51.878,23.96,72.52 c3.204,4.241,2.379,2.744,2.379,2.744c1.95,2.25,4.823,3.496,7.801,3.374c2.994-0.13,5.762-1.602,7.517-4.03l32.967-45.396 C215.152,279.936,216.001,274.482,214.391,269.53z"></path> <path class="st0" d="M269.198,306.47c-3.074-4.216-7.978-6.716-13.198-6.716c-5.22,0-10.123,2.5-13.206,6.716l-32.943,45.356 c-1.764,2.42-2.314,5.51-1.513,8.399c0.818,2.889,2.889,5.228,5.656,6.393c0,0-1.011,0.025,4.346,1.82 c25.044,8.392,51.951,8.028,76.388-0.396c5.025-1.724,3.334-1.4,3.334-1.4c2.752-1.158,4.823-3.512,5.616-6.385 c0.817-2.889,0.251-5.98-1.506-8.392L269.198,306.47z"></path> <path class="st0" d="M361.448,241.709l-53.375,17.342c-4.952,1.602-8.853,5.502-10.471,10.479 c-1.611,4.953-0.752,10.407,2.323,14.614l32.958,45.356c1.748,2.436,4.515,3.893,7.509,4.038c2.995,0.122,5.868-1.141,7.826-3.406 c0,0-0.283,0.963,3.084-3.576c15.706-21.218,23.685-46.934,23.224-72.764c-0.089-5.3-0.307-3.593-0.307-3.593 c-0.235-2.986-1.846-5.697-4.338-7.348C367.395,241.216,364.28,240.779,361.448,241.709z"></path> <path class="st0" d="M281.708,220.613c4.233,3.059,9.67,3.924,14.63,2.323l53.327-17.342c2.848-0.922,5.114-3.099,6.15-5.907 c1.036-2.8,0.744-5.923-0.818-8.488c0,0,0.834,0.567-2.452-4.03c-15.318-21.508-37.288-37.038-62.025-44.596 c-5.065-1.537-3.528-0.809-3.528-0.809c-2.905-0.68-5.956,0.008-8.31,1.877c-2.331,1.837-3.69,4.669-3.69,7.656v56.11 C274.984,212.634,277.492,217.538,281.708,220.613z"></path> </g> </g><
                                /svg>     
                             </span>
                             </div>
                        <table class="min-w-full divide-y divide-gray-200"> <colgroup> <col style="width: 30%;">
                                <col style="width: 30%;">
                                <col style="width: 40%;">
                            </colgroup>
                            <thead class="player-status-header">
                                <tr>
                                    <th scope="col">Player</th>
                                    <th scope="col" class="text-center">Status</th>
                                    <th scope="col" class="text-center">Attendance</th>
                                </tr>
                            </thead>
                            <tbody id="player-list" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="3" class="text-center py-4 text-gray-500">Loading players...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="info-panel lg:col-span-1">
                         <h3 class="text-xl font-semibold">Schedule & Info</h3>
                         <p><strong>Confirmation Deadline:</strong> 21:00</p>
                         <p><strong>Team Setup:</strong> 21:15 - 21:45</p>
                         <p><strong>Be Online By:</strong> 21:45</p>
                         <p><strong>Match Start:</strong> 22:00</p>
                         <hr class="border-gray-200 my-4">
                         <h4 class="text-lg font-semibold mb-2 text-blue-600">Drafting Rules</h4>
                         <ul class="list-disc list-inside text-sm space-y-1 text-gray-600">
                             <li>Coin toss winner chooses first pick OR gives first pick away.</li>
                             <li>Picks follow 1-2-2-2-2-1 format.</li>
                             <li>Reroll if teams seem unbalanced.</li>
                             <li>Coin toss loser picks 2nd & 3rd map bans.</li>
                             <li>Coin toss winner picks 1st map ban.</li>
                             <li>Coin toss winner chooses side on Map 1 & 3.</li>
                             <li>Coin toss loser chooses side on Map 2.</li>
                         </ul>
                    </div>
                </div>
            </div>

            <div id="page-batak_domination" class="page-content hidden page-content-container">
                <h2 class="text-2xl font-semibold text-blue-600">Batak Domination</h2>
                <div class="mt-6 flex justify-center">
                    <img src="images/BatakDom.jpg" alt="Batak Domination" class="max-w-full h-auto rounded-lg shadow-md" />
                </div>
                <div id="batak-data-content" class="mt-4"></div>
            </div>
            <div id="page-sonmac" class="page-content hidden page-content-container">
                <h2 class="text-2xl font-semibold text-blue-600 mb-4">Son Maç</h2>
                
                <!-- Map tabs navigation -->
                <div class="mb-4 border-b border-gray-200">
                    <ul id="map-tabs" class="flex flex-wrap -mb-px text-sm font-medium text-center">
                        <!-- Map tabs will be dynamically generated here -->
                    </ul>
                </div>
                
                <!-- Map tab content -->
                <div id="mapTabContent">
                    <!-- Map content will be dynamically generated here -->
                </div>
            </div>
            <div id="page-gece_ortalama" class="page-content hidden page-content-container">
                <h2 class="text-2xl font-semibold text-blue-600 mb-4">Gece Ortalaması</h2>
                <div class="overflow-x-auto">
                    <table class="styled-table min-w-full text-sm">
                        <thead>
                            <tr>
                                <th class="sortable-header" data-sort-key="name">Oyuncu</th>
                                <th class="sortable-header" data-sort-key="HLTV 2">HLTV2</th>
                                <th class="sortable-header" data-sort-key="ADR">ADR</th>
                                <th class="sortable-header" data-sort-key="K/D">K/D</th>
                                <th class="sortable-header" data-sort-key="HLTV2 DIFF">HLTV2 DIFF</th>
                                <th class="sortable-header" data-sort-key="ADR DIFF">ADR DIFF</th>
                                <th class="sortable-header" data-sort-key="MVP">MVP</th>
                                <th class="sortable-header" data-sort-key="Kills">Kills</th>
                                <th class="sortable-header" data-sort-key="Deaths">Deaths</th>
                                <th class="sortable-header" data-sort-key="Assists">Assists</th>
                                <th class="sortable-header" data-sort-key="HS">HS</th>
                                <th class="sortable-header" data-sort-key="HS/Kill ratio">HS/Kill ratio</th>
                                <th class="sortable-header" data-sort-key="First Kill">First Kill</th>
                                <th class="sortable-header" data-sort-key="First Death">First Death</th>
                                <th class="sortable-header" data-sort-key="Bomb Planted">Bomb Planted</th>
                                <th class="sortable-header" data-sort-key="Bomb Defused">Bomb Defused</th>
                                <th class="sortable-header" data-sort-key="HLTV">HLTV</th>
                                <th class="sortable-header" data-sort-key="KAST">KAST</th>
                                <th class="sortable-header" data-sort-key="Utility Damage">Utility Damage</th>
                                <th class="sortable-header" data-sort-key="2 kills">2 kills</th>
                                <th class="sortable-header" data-sort-key="3 kills">3 kills</th>
                                <th class="sortable-header" data-sort-key="4 kills">4 kills</th>
                                <th class="sortable-header" data-sort-key="5 kills">5 kills</th>
                                <th class="sortable-header" data-sort-key="Nr of Matches">Nr of Matches</th>
                                <th class="sortable-header" data-sort-key="Clutch Opportunity">Clutch Opportunity</th>
                                <th class="sortable-header" data-sort-key="Clutches Won">Clutches Won</th>
                            </tr>
                        </thead>
                        <tbody id="night-avg-table-body">
                            <!-- Data rows will be injected here by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div id="page-last10" class="page-content hidden page-content-container">
                <h2 class="text-2xl font-semibold text-blue-600 mb-4">Son 10 Ortalaması</h2>
                <div class="overflow-x-auto">
                    <table class="styled-table min-w-full text-sm">
                        <thead>
                            <tr>
                                <th class="sortable-header" data-sort-key="name">Oyuncu</th>
                                <th class="sortable-header" data-sort-key="hltv_2">HLTV2</th>
                                <th class="sortable-header" data-sort-key="adr">ADR</th>
                                <th class="sortable-header" data-sort-key="kd">K/D</th>
                                <th class="sortable-header" data-sort-key="mvp">MVP</th>
                                <th class="sortable-header" data-sort-key="kills">Kills</th>
                                <th class="sortable-header" data-sort-key="deaths">Deaths</th>
                                <th class="sortable-header" data-sort-key="assists">Assists</th>
                                <th class="sortable-header" data-sort-key="hs">HS</th>
                                <th class="sortable-header" data-sort-key="hs_ratio">HS/Kill ratio</th>
                                <th class="sortable-header" data-sort-key="first_kill">First Kill</th>
                                <th class="sortable-header" data-sort-key="first_death">First Death</th>
                                <th class="sortable-header" data-sort-key="bomb_planted">Bomb Planted</th>
                                <th class="sortable-header" data-sort-key="bomb_defused">Bomb Defused</th>
                                <th class="sortable-header" data-sort-key="hltv">HLTV</th>
                                <th class="sortable-header" data-sort-key="kast">KAST</th>
                                <th class="sortable-header" data-sort-key="utl_dmg">Utility Damage</th>
                                <th class="sortable-header" data-sort-key="two_kills">2 kills</th>
                                <th class="sortable-header" data-sort-key="three_kills">3 kills</th>
                                <th class="sortable-header" data-sort-key="four_kills">4 kills</th>
                                <th class="sortable-header" data-sort-key="five_kills">5 kills</th>
                                <th class="sortable-header" data-sort-key="matches">Nr of Matches</th>
                                <th class="sortable-header" data-sort-key="win_rate">WIN RATE (%)</th>
                                <th class="sortable-header" data-sort-key="avg_clutches">Nr of clutches per game</th>
                                <th class="sortable-header" data-sort-key="avg_clutches_won">Clutches Won</th>
                                <th class="sortable-header" data-sort-key="clutch_success">Successful Clutch (%)</th>
                            </tr>
                        </thead>
                        <tbody id="last10-table-body">
                            <!-- Data rows will be injected here by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div id="page-season_avg" class="page-content hidden page-content-container">
                <h2 class="text-2xl font-semibold text-blue-600 mb-4">Sezon Ortalaması</h2>
                <div class="overflow-x-auto">
                    <table class="styled-table min-w-full text-sm">
                        <thead>
                            <tr>
                                <th class="sortable-header" data-sort-key="name">Oyuncu</th>
                                <th class="sortable-header" data-sort-key="hltv_2">HLTV2</th>
                                <th class="sortable-header" data-sort-key="adr">ADR</th>
                                <th class="sortable-header" data-sort-key="kd">K/D</th>
                                <th class="sortable-header" data-sort-key="mvp">MVP</th>
                                <th class="sortable-header" data-sort-key="kills">Kills</th>
                                <th class="sortable-header" data-sort-key="deaths">Deaths</th>
                                <th class="sortable-header" data-sort-key="assists">Assists</th>
                                <th class="sortable-header" data-sort-key="hs">HS</th>
                                <th class="sortable-header" data-sort-key="hs_ratio">HS/Kill ratio</th>
                                <th class="sortable-header" data-sort-key="first_kill">First Kill</th>
                                <th class="sortable-header" data-sort-key="first_death">First Death</th>
                                <th class="sortable-header" data-sort-key="bomb_planted">Bomb Planted</th>
                                <th class="sortable-header" data-sort-key="bomb_defused">Bomb Defused</th>
                                <th class="sortable-header" data-sort-key="hltv">HLTV</th>
                                <th class="sortable-header" data-sort-key="kast">KAST</th>
                                <th class="sortable-header" data-sort-key="utl_dmg">Utility Damage</th>
                                <th class="sortable-header" data-sort-key="two_kills">2 kills</th>
                                <th class="sortable-header" data-sort-key="three_kills">3 kills</th>
                                <th class="sortable-header" data-sort-key="four_kills">4 kills</th>
                                <th class="sortable-header" data-sort-key="five_kills">5 kills</th>
                                <th class="sortable-header" data-sort-key="matches">Nr of Matches</th>
                                <th class="sortable-header" data-sort-key="win_rate">WIN RATE (%)</th>
                                <th class="sortable-header" data-sort-key="avg_clutches">Nr of clutches per game</th>
                                <th class="sortable-header" data-sort-key="avg_clutches_won">Clutches Won</th>
                                <th class="sortable-header" data-sort-key="clutch_success">Successful Clutch (%)</th>
                            </tr>
                        </thead>
                        <tbody id="season-avg-table-body">
                            <!-- Data rows will be injected here by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="page-duello_son_mac" class="page-content hidden page-content-container">
                <h2 class="text-2xl font-semibold text-blue-600 mb-4">Düello Son Maç</h2>
                <div id="duello-grid-container" class="overflow-x-auto w-full">
                    <table id="duello-table" class="table-fixed border-collapse" style="min-width: 1200px;">
                        <!-- Table content will be dynamically generated by JS -->
                        <thead>
                            <tr>
                                <th class="w-32 p-3 border bg-gray-50 font-semibold text-gray-700"></th>
                                <th colspan="20" class="text-center p-4 text-gray-500">Loading duels...</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>

        </div> </div>

    <script>
        // --- Constants ---
        const APPS_SCRIPT_URL = 'https://royal-flower-aa89.onur1atak.workers.dev/'; // Replace with your actual URL
        const ATTENDANCE_STATES = ["not_coming", "no_response", "coming"]; // Order matters for cycling
        const DEFAULT_PAGE = 'season_avg';
        const TEKER_DONDU_THRESHOLD = 10; // Number of players needed for the wheel
        const SEASON_AVG_JSON_URL = 'data/season_avg.json';
        const LAST10_JSON_URL = 'data/last10.json';
        const NIGHT_AVG_JSON_URL = 'data/night_avg.json';
        const SONMAC_JSON_URL = 'data/sonmac.json';
        const DUELLO_JSON_URL = 'data/duello_son_mac.json'; // Added Duello JSON URL

        // --- State ---
        let players = []; // Initialize empty, will be filled by fetch
        let currentTimeoutId = null; // To manage message timeout

        // --- DOM Elements ---
        const playerListBody = document.getElementById('player-list');
        const pageContentArea = document.getElementById('page-content-area');
        const updateButton = document.getElementById('update-stats-button');
        const messageArea = document.getElementById('message-area');
        const spinner = document.getElementById('spinner');
        // Updated summary elements
        const attendanceSummaryDiv = document.getElementById('attendance-summary');
        const summaryTextSpan = document.getElementById('summary-text');
        const tekerDonduIndicator = document.getElementById('teker-dondu-indicator');
        // Nav elements
        const menuButton = document.getElementById('menu-button');
        const navLinksContainer = document.getElementById('main-nav-links');
        const navLinks = navLinksContainer.querySelectorAll('.tab-nav-item');
        const iconHamburger = document.getElementById('icon-hamburger');
        const iconClose = document.getElementById('icon-close');

        // --- Helper Functions ---

        /**
         * Displays a message to the user (success or error).
         * @param {string} text - The message text.
         * @param {'success' | 'error'} type - The type of message.
         * @param {number} duration - How long to show the message in ms.
         */
        function showMessage(text, type = 'error', duration = 5000) {
            // Clear previous timeout if exists
            if (currentTimeoutId) {
                clearTimeout(currentTimeoutId);
            }

            messageArea.textContent = text;
            // Reset classes, keeping base ones if needed (like hidden initially)
            messageArea.className = 'hidden'; // Start hidden
            messageArea.classList.add(type); // Add 'success' or 'error' class
            messageArea.classList.remove('hidden'); // Make visible

            // Set timeout to hide the message
            currentTimeoutId = setTimeout(() => {
                messageArea.classList.add('hidden');
                messageArea.classList.remove(type);
                currentTimeoutId = null; // Reset timeout ID
            }, duration);
        }

        /**
         * Renders the player list in the table and updates the summary.
         */
        function renderPlayers() {
            // Ensure required DOM elements exist
            if (!playerListBody || !attendanceSummaryDiv || !summaryTextSpan || !tekerDonduIndicator) {
                console.error("Required DOM elements for rendering players/summary are missing.");
                return;
            }
            playerListBody.innerHTML = ''; // Clear existing rows

            // Define default summary state
            let summaryBgClass = 'bg-red-100';
            let summaryTextClass = 'text-red-800';
            let wheelColorClass = 'text-red-800'; // Match wheel color to text

            // Handle case where player data is not available
            if (players.length === 0) {
                 playerListBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">No player data available. Try updating.</td></tr>';
                 summaryTextSpan.textContent = 'Gelen oyuncu: 0  Belirsiz: 0';
                 tekerDonduIndicator.classList.add('hidden'); // Ensure indicator is hidden
            } else {
                // Calculate counts
                let countComing = 0;
                let countNoResponse = 0;
                players.forEach(player => {
                    if (player.attendance === 'coming') countComing++;
                    if (player.attendance === 'no_response') countNoResponse++;
                });

                // Update summary text
                summaryTextSpan.textContent = `Gelen oyuncu: ${countComing}  Belirsiz: ${countNoResponse}`;

                // Determine background/text colors and Show/hide the "Teker Döndü" indicator
                if (countComing >= TEKER_DONDU_THRESHOLD) {
                    summaryBgClass = 'bg-green-100';
                    summaryTextClass = 'text-green-800';
                    wheelColorClass = 'text-green-800'; // Match wheel color
                    tekerDonduIndicator.classList.remove('hidden');
                } else {
                    // Keep default red colors defined above
                    tekerDonduIndicator.classList.add('hidden');
                }
            }

            // Apply summary styles
            // Remove potentially existing color classes first
            attendanceSummaryDiv.classList.remove('bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'text-gray-700');
            tekerDonduIndicator.classList.remove('text-green-800', 'text-red-800', 'text-gray-600'); // Remove potential wheel colors

            // Add the determined classes
            attendanceSummaryDiv.classList.add(summaryBgClass, summaryTextClass);
            if (!tekerDonduIndicator.classList.contains('hidden')) {
                 tekerDonduIndicator.classList.add(wheelColorClass);
            }


            // Define attendance state configurations (styles and text)
            const stateConfigs = {
                coming: { text: 'Geliyor', bgColor: 'bg-green-500', textColor: 'text-white' },
                not_coming: { text: 'Gelmiyor', bgColor: 'bg-red-500', textColor: 'text-white' },
                no_response: { text: 'Belirsiz', bgColor: 'bg-gray-300', textColor: 'text-gray-900' }
            };

            // Create and append rows for each player (only if players exist)
            if (players.length > 0) {
                players.forEach((player) => {
                    const row = document.createElement('tr');
                    row.setAttribute('data-player-name', player.name);

                    // 1) Name cell
                    const nameCell = document.createElement('td');
                    nameCell.className = 'font-medium text-gray-900 whitespace-nowrap'; // Keep nowrap on larger screens
                    nameCell.textContent = player.name;
                    row.appendChild(nameCell);

                    // 2) Status cell
                    const statusCell = document.createElement('td');
                    statusCell.className = 'text-center'; // Center align status content
                    const statusBadge = document.createElement('span');
                    // *** Use rounded-md and ensure status-badge class is present ***
                    statusBadge.className = 'status-badge px-2 py-1 text-xs font-medium rounded-md'; // Changed to rounded-md

                    // --- Status Text Logic ---
                    let displayStatus = 'Unknown'; // Default display text
                    const originalStatus = (player.status || '').toLowerCase(); // Get original status safely

                    if (originalStatus.includes('aktif')) {
                        displayStatus = 'Aktif Oyuncu'; // Simplified active text
                    } else if (originalStatus === 'adam evde yok') {
                        displayStatus = 'Evde Yok'; // Simplified inactive text as requested
                    } else if (player.status) {
                        displayStatus = player.status; // Use original if not recognized but exists
                    }
                    statusBadge.textContent = displayStatus;
                    // --- End Status Text Logic ---


                    // Color-code the status badge based on the *original* status logic
                    if (originalStatus.includes('aktif')) {
                        statusBadge.classList.add('bg-green-100', 'text-green-800');
                    } else if (originalStatus === 'adam evde yok' || originalStatus.includes('inactive')) { // Check original logic conditions
                        statusBadge.classList.add('bg-red-100', 'text-red-800');
                    } else {
                        statusBadge.classList.add('bg-gray-100', 'text-gray-800'); // Default/Unknown style
                    }
                    statusCell.appendChild(statusBadge);
                    row.appendChild(statusCell);

                    // 3) Attendance cell (using the improved control)
                    const attendanceCell = document.createElement('td');
                    attendanceCell.className = 'text-center'; // Center content within the cell

                    const currentState = player.attendance || 'no_response';
                    const config = stateConfigs[currentState];

                    // Container for the control
                    const container = document.createElement('div');
                    container.className = 'attendance-control-container'; // Centered flex container

                    // Left arrow button (using SVG)
                    const leftArrowBtn = document.createElement('button');
                    leftArrowBtn.className = 'attendance-arrow';
                    leftArrowBtn.setAttribute('aria-label', `Previous status for ${player.name}`);
                    leftArrowBtn.setAttribute('data-direction', 'left');
                    leftArrowBtn.setAttribute('data-player', player.name);
                    leftArrowBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg>`; // Left chevron SVG

                    // Status pill label - Apply fixed width via inline style or Tailwind arbitrary value class
                    const labelSpan = document.createElement('span');
                    // Apply base classes and dynamic background/text color
                    labelSpan.className = `attendance-label ${config.bgColor} ${config.textColor}`;
                    // Add fixed width style directly (alternative: use w-[76px] in className)
                    // labelSpan.style.width = '76px'; // Apply fixed width directly
                    labelSpan.textContent = config.text;
                    labelSpan.setAttribute('data-state', currentState); // Store current state
                    labelSpan.setAttribute('data-player', player.name); // Link to player

                    // Right arrow button (using SVG)
                    const rightArrowBtn = document.createElement('button');
                    rightArrowBtn.className = 'attendance-arrow';
                    rightArrowBtn.setAttribute('aria-label', `Next status for ${player.name}`);
                    rightArrowBtn.setAttribute('data-direction', 'right');
                    rightArrowBtn.setAttribute('data-player', player.name);
                    rightArrowBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>`; // Right chevron SVG

                    // Append elements to the container
                    container.appendChild(leftArrowBtn);
                    container.appendChild(labelSpan);
                    container.appendChild(rightArrowBtn);

                    // Append the container to the cell
                    attendanceCell.appendChild(container);
                    row.appendChild(attendanceCell);

                    // Add the row to the table body
                    playerListBody.appendChild(row);
                });
            } // End player loop
        }

        /**
         * Fetches attendance data from the Google Apps Script endpoint.
         */
        async function fetchStatsFromSheet() {
            spinner.classList.remove('hidden');
            updateButton.disabled = true;
            try {
                const response = await fetch(APPS_SCRIPT_URL);
                if (!response.ok) {
                    // Try to get more specific error from response body if possible
                    let errorDetails = `HTTP error! Status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorDetails += ` - ${errorData.message || JSON.stringify(errorData)}`;
                    } catch (e) { /* Ignore if response is not JSON */ }
                    throw new Error(errorDetails);
                }
                const data = await response.json();
                // Basic validation: Check if it's an array
                if (!Array.isArray(data)) {
                    console.error("Received data is not an array:", data);
                    throw new Error("Invalid data format received from server.");
                }
                players = data; // Update the global players array
                renderPlayers(); // Re-render the table with new data
                //showMessage('Attendance data loaded successfully!', 'success');
            } catch (err) {
                console.error('Failed to fetch stats:', err);
                showMessage(`Error loading data: ${err.message}`, 'error');
                // Optionally render with empty state or keep old data
                 renderPlayers(); // Render even on error to show empty state or previous data
            } finally {
                spinner.classList.add('hidden');
                updateButton.disabled = false;
            }
        }

        /**
         * Sends an attendance update for a specific player to the Google Apps Script endpoint.
         * @param {string} playerName - The name of the player to update.
         * @param {string} newAttendance - The new attendance status ('coming', 'not_coming', 'no_response').
         */
        async function updateAttendanceInSheet(playerName, newAttendance) {
            // Optional: Add visual feedback (e.g., temporary spinner on the row)
            console.log(`Attempting to update ${playerName} to ${newAttendance}`);
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    // Use 'no-cors' if your Apps Script is not configured for CORS preflight (simple requests)
                    // mode: 'no-cors', // Uncomment if needed, but you won't get response details back
                    headers: {
                        // 'Content-Type': 'application/json' // Needed for standard CORS
                        'Content-Type': 'text/plain;charset=utf-8', // Often needed for simple 'no-cors' POST to Apps Script
                    },
                    // Body needs to be stringified for application/json or simple text for text/plain
                     body: JSON.stringify({ name: playerName, attendance: newAttendance }),
                    // Example for text/plain if Apps Script expects that:
                    // body: `name=${encodeURIComponent(playerName)}&attendance=${encodeURIComponent(newAttendance)}`
                });

                // Note: With 'no-cors', response.ok will likely be false even on success.
                // You might need to rely on the absence of network errors.
                // If using standard CORS (recommended):
                 if (!response.ok) {
                     let errorText = `Network response was not ok (Status: ${response.status})`;
                     try {
                        // Try to parse error response if server sends JSON errors
                        const errorData = await response.json();
                        errorText += `: ${errorData.message || JSON.stringify(errorData)}`;
                     } catch(e) {
                        // Fallback if error response isn't JSON
                        errorText = await response.text();
                     }
                     throw new Error(errorText);
                 }
                 // If using standard CORS and expecting JSON response:
                 // const result = await response.json();
                 // console.log('Update successful:', result);

                console.log(`Attendance updated successfully in sheet for ${playerName} to ${newAttendance}`);
                // Optional: Show temporary success message
                // showMessage(`${playerName}'s status updated!`, 'success', 2000);

            } catch (error) {
                console.error('Failed to update attendance in sheet:', error);
                showMessage(`Failed to update status for ${playerName}: ${error.message}`, 'error');
                // OPTIONAL: Revert the UI change if the update fails
                // To do this, you'd need to store the *previous* state before the optimistic update
                // and call fetchStatsFromSheet() or manually revert the specific player's state and re-render.
                // Example (simple refetch):
                // showMessage(`Update failed for ${playerName}. Reverting...`, 'error');
                // await fetchStatsFromSheet(); // Refetch to get the actual state from the sheet
            } finally {
                 // Optional: Remove row-specific spinner if added
            }
        }


        /**
         * Handles clicks within the player list table, specifically for attendance changes.
         * Uses event delegation. Detects clicks on arrows OR the label itself.
         * @param {Event} event - The click event object.
         */
        async function handlePlayerListClick(event) {
            const targetArrow = event.target.closest('.attendance-arrow');
            const targetLabel = event.target.closest('.attendance-label');
            let playerName = null;
            let direction = null; // 'left', 'right', or null if label clicked
            let playerIndex = -1;
            let isLabelClick = false;

            if (targetArrow) {
                // Clicked on an arrow button
                playerName = targetArrow.getAttribute('data-player');
                direction = targetArrow.getAttribute('data-direction');
            } else if (targetLabel) {
                 // Clicked directly on the label pill
                 isLabelClick = true;
                 playerName = targetLabel.getAttribute('data-player');
                 // Determine direction based on click position
                 const rect = targetLabel.getBoundingClientRect();
                 const clickX = event.clientX - rect.left; // X position within the element
                 direction = (clickX < rect.width / 2) ? 'left' : 'right'; // Left half or right half
            }

            if (playerName) {
                playerIndex = players.findIndex(p => p.name === playerName);
            }

            if (playerIndex > -1 && direction) {
                // Common logic for both arrow and label clicks
                const currentState = players[playerIndex].attendance || 'no_response';
                let currentIndex = ATTENDANCE_STATES.indexOf(currentState);

                // Calculate the new index based on direction
                if (direction === 'left') {
                    currentIndex = (currentIndex - 1 + ATTENDANCE_STATES.length) % ATTENDANCE_STATES.length;
                } else { // 'right'
                    currentIndex = (currentIndex + 1) % ATTENDANCE_STATES.length;
                }

                const newState = ATTENDANCE_STATES[currentIndex];

                // Optimistic UI Update
                players[playerIndex].attendance = newState;
                renderPlayers(); // Update the UI

                // Asynchronously update the backend
                await updateAttendanceInSheet(playerName, newState);
            } else if (playerName && !direction) {
                 console.warn(`Could not determine click direction for player ${playerName}`);
            } else if (targetArrow || targetLabel) {
                 console.warn(`Player data not found for clicked element.`);
            }
            // If click was not on an arrow or label, do nothing.
        }


        // --- Navigation Logic ---

        /**
         * Shows the specified page content and updates navigation link styles.
         * @param {string} pageId - The ID of the page to show (e.g., 'attendance', 'draft').
         */
        function showPage(pageId) {
            const allPages = pageContentArea.querySelectorAll('.page-content');
            allPages.forEach(page => {
                page.classList.add('hidden'); // Hide all pages
            });

            const targetPage = document.getElementById(`page-${pageId}`);
            if (targetPage) {
                targetPage.classList.remove('hidden'); // Show the target page
            } else {
                console.error(`Page content with ID 'page-${pageId}' not found.`);
                // Optionally show a default page or an error message
                document.getElementById(`page-${DEFAULT_PAGE}`)?.classList.remove('hidden');
                pageId = DEFAULT_PAGE; // Fallback to default
            }

            // Update navigation link active states
            navLinks.forEach(link => {
                link.classList.remove('active');
                // Remove mobile-specific active styles if they exist
                link.classList.remove('bg-blue-50', 'border-l-blue-500', 'text-blue-600'); // More specific removal

                if (link.getAttribute('data-page') === pageId) {
                    link.classList.add('active'); // Add active class to the correct link
                    // Apply mobile-specific active styles if the menu is currently in mobile view
                    if (navLinksContainer.classList.contains('mobile-menu-active')) {
                         link.classList.add('bg-eff6ff', 'border-l-blue-600', 'text-blue-600'); // Use actual color codes if needed
                    }
                }
            });

            // If switching to attendance page, ensure players are rendered (might be redundant if already rendered)
            // if (pageId === 'attendance') {
            //     renderPlayers();
            // }

             // Close mobile menu after selecting an item (optional but good UX)
             if (navLinksContainer.classList.contains('mobile-menu-active')) {
                toggleMobileMenu(false); // Force close
             }
        }

        /**
         * Toggles the visibility and state of the mobile navigation menu.
         * @param {boolean} [forceState] - Optional. Force 'true' to open, 'false' to close.
         */
        function toggleMobileMenu(forceState) {
            const shouldBeOpen = forceState !== undefined ? forceState : menuButton.getAttribute('aria-expanded') === 'false';

            menuButton.setAttribute('aria-expanded', shouldBeOpen);
            iconHamburger.classList.toggle('hidden', shouldBeOpen);
            iconClose.classList.toggle('hidden', !shouldBeOpen);

            // Use Tailwind classes for visibility on mobile
            navLinksContainer.classList.toggle('hidden', !shouldBeOpen); // Hide if not open
             // Add/remove classes that define the mobile menu appearance
            navLinksContainer.classList.toggle('mobile-menu-active', shouldBeOpen);


            // Re-apply active styles correctly when opening/closing
            const activeLink = navLinksContainer.querySelector('.tab-nav-item.active');
            if (activeLink) {
                // Remove potentially incorrect mobile styles first
                activeLink.classList.remove('bg-eff6ff', 'border-l-blue-600', 'text-blue-600');
                if (shouldBeOpen) {
                    // Add mobile active styles only if opening
                     activeLink.classList.add('bg-eff6ff', 'border-l-blue-600', 'text-blue-600');
                }
            }
        }

        /**
         * Fetches season average player stats from the local JSON file.
         */
        async function fetchSeasonAvgStats() {
            try {
                const response = await fetch(SEASON_AVG_JSON_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();
                if (!Array.isArray(data)) {
                    throw new Error("Invalid data format received from JSON file.");
                }
                return data;
            } catch (err) {
                console.error('Failed to fetch season avg stats:', err);
                showMessage(`Error loading season stats: ${err.message}`, 'error');
                return [];
            }
        }

        // Example usage: fetch and render
        async function loadAndRenderSeasonAvgTable() {
            const stats = await fetchSeasonAvgStats();
            if (stats.length > 0) {
                // Initial sort
                sortData(stats, 'hltv_2', 'desc');
                // Render
                fillSeasonAvgTable(stats);
                // Set initial header indicator
                const tbody = document.getElementById('season-avg-table-body');
                setInitialSortState(tbody, 'hltv_2', 'desc');
            }
        }

        // Modify fillSeasonAvgTable to accept data as a parameter:
        function fillSeasonAvgTable(data, tbody) {
            // Get tbody if not provided
            tbody = tbody || document.getElementById('season-avg-table-body');
            if (!tbody) return;

            // Store original data ONLY if it doesn't exist (first load)
            if (!tbody.dataset.originalData) {
                tbody.dataset.originalData = JSON.stringify(data);
            }
            
            tbody.innerHTML = ''; // Clear existing rows

            // Render rows from the provided data array
            data.forEach(row => {
                // Helper to safely format numbers or return 'N/A'
                const formatNum = (num, decimals = 2) => (typeof num === 'number' ? num.toFixed(decimals) : 'N/A');
                const formatPercent = (num) => (typeof num === 'number' ? num.toFixed(2) + '%' : 'N/A');

                const tr = document.createElement('tr');
                // Apply ONLY stat-badge class to spans in the HTML string
                tr.innerHTML = `
                    <td class="font-medium text-gray-900 whitespace-nowrap">${row.name || 'N/A'}</td>
                    <td class="stat-badge-cell"><span class="stat-badge">${formatNum(row.hltv_2)}</span></td>
                    <td class="stat-badge-cell"><span class="stat-badge">${formatNum(row.adr, 0)}</span></td>
                    <td class="stat-badge-cell"><span class="stat-badge">${formatNum(row.kd)}</span></td>
                    <td class="text-center">${formatNum(row.mvp)}</td>
                    <td class="text-center">${formatNum(row.kills)}</td>
                    <td class="text-center">${formatNum(row.deaths)}</td>
                    <td class="text-center">${formatNum(row.assists)}</td>
                    <td class="text-center">${formatNum(row.hs)}</td>
                    <td class="text-center">${formatPercent(row.hs_ratio)}</td>
                    <td class="text-center">${formatNum(row.first_kill)}</td>
                    <td class="text-center">${formatNum(row.first_death)}</td>
                    <td class="text-center">${formatNum(row.bomb_planted)}</td>
                    <td class="text-center">${formatNum(row.bomb_defused)}</td>
                    <td class="text-center">${formatNum(row.hltv)}</td>
                    <td class="text-center">${formatPercent(row.kast)}</td>
                    <td class="text-center">${formatNum(row.utl_dmg)}</td>
                    <td class="text-center">${formatNum(row.two_kills)}</td>
                    <td class="text-center">${formatNum(row.three_kills)}</td>
                    <td class="text-center">${formatNum(row.four_kills)}</td>
                    <td class="text-center">${formatNum(row.five_kills)}</td>
                    <td class="text-center">${row.matches ?? 'N/A'}</td>
                    <td class="text-center">${formatPercent(row.win_rate)}</td>
                    <td class="text-center">${formatNum(row.avg_clutches)}</td>
                    <td class="text-center">${formatNum(row.avg_clutches_won)}</td>
                    <td class="text-center">${formatPercent(row.clutch_success)}</td>
                `;
                tbody.appendChild(tr);
            });

            // Apply heatmap AFTER rows are in the DOM
            const gradient = [
                { percent: 0, color: '#EF4444' },   // Red-500
                { percent: 0.5, color: '#FDE68A' }, // Yellow-200 (the lighter one)
                { percent: 1, color: '#22C55E' }    // Green-500
            ];
            applyHeatmapToColumn(tbody.id, 1, gradient); // HLTV2 (index 1)
            applyHeatmapToColumn(tbody.id, 2, gradient); // ADR (index 2)
            applyHeatmapToColumn(tbody.id, 3, gradient); // K/D (index 3)
        }

        /**
         * Fetches nightly average player stats from the local JSON file.
         */
        async function fetchNightAvgStats() {
            try {
                const response = await fetch(NIGHT_AVG_JSON_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();
                if (!Array.isArray(data)) {
                    throw new Error("Invalid data format received from JSON file.");
                }
                return data;
            } catch (err) {
                console.error('Failed to fetch night avg stats:', err);
                showMessage(`Error loading night stats: ${err.message}`, 'error');
                return [];
            }
        }

        /**
         * Fetches last 10 average player stats from the local JSON file.
         */
        async function fetchLast10Stats() {
            try {
                const response = await fetch(LAST10_JSON_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();
                if (!Array.isArray(data)) {
                    throw new Error("Invalid data format received from JSON file.");
                }
                return data;
            } catch (err) {
                console.error('Failed to fetch last 10 stats:', err);
                showMessage(`Error loading last 10 stats: ${err.message}`, 'error');
                return []; // Return empty array on error
            }
        }

        // Function to fetch and render the last 10 games data
        async function loadAndRenderLast10Table() {
            // console.log("loadAndRenderLast10Table: Starting"); // Log start // REMOVED LOG
            const stats = await fetchLast10Stats();
            // console.log("loadAndRenderLast10Table: Fetched stats:", stats?.length > 0 ? `${stats.length} rows` : stats); // Log fetched data (or length) // REMOVED LOG
            if (stats && stats.length > 0) { // Add check for stats being defined
                 // Initial sort
                sortData(stats, 'hltv_2', 'desc');
                // Render
                fillLast10Table(stats);
                 // Set initial header indicator
                const tbody = document.getElementById('last10-table-body');
                setInitialSortState(tbody, 'hltv_2', 'desc');
            }
        }

        // NEW: Function to fill the Last 10 table (mirrors fillSeasonAvgTable)
        function fillLast10Table(data, tbody) {
            // console.log("fillLast10Table: Starting", data ? `${data.length} rows` : data); // Log start and data // REMOVED LOG
            // Get tbody if not provided
            tbody = tbody || document.getElementById('last10-table-body');
            if (!tbody) {
                // console.error("fillLast10Table: tbody with id 'last10-table-body' not found."); // REMOVED LOG
                return;
            }
            // console.log("fillLast10Table: Found tbody", tbody.id); // Log tbody found // REMOVED LOG

            // Store original data ONLY if it doesn't exist (first load)
            if (!tbody.dataset.originalData) {
                tbody.dataset.originalData = JSON.stringify(data);
            }
            
            tbody.innerHTML = ''; // Clear existing rows
            // console.log("fillLast10Table: Cleared tbody"); // Log tbody cleared // REMOVED LOG

            // Render rows from the provided data array
            data.forEach((row, index) => {
                 // if (index === 0) { // REMOVED LOG
                 //     console.log("fillLast10Table: Processing first row:", row); // Log first row data // REMOVED LOG
                 // } // REMOVED LOG
                // Helper to safely format numbers or return 'N/A'
                const formatNum = (num, decimals = 2) => (typeof num === 'number' ? num.toFixed(decimals) : 'N/A');
                const formatPercent = (num) => (typeof num === 'number' ? num.toFixed(2) + '%' : 'N/A');

                const tr = document.createElement('tr');
                // Apply ONLY stat-badge class to spans in the HTML string
                // Use the same keys as season avg, assuming last10.json has the same structure
                tr.innerHTML = `
                    <td class="font-medium text-gray-900 whitespace-nowrap">${row.name || 'N/A'}</td>
                    <td class="stat-badge-cell"><span class="stat-badge">${formatNum(row.hltv_2)}</span></td>
                    <td class="stat-badge-cell"><span class="stat-badge">${formatNum(row.adr, 0)}</span></td>
                    <td class="stat-badge-cell"><span class="stat-badge">${formatNum(row.kd)}</span></td>
                    <td class="text-center">${formatNum(row.mvp)}</td>
                    <td class="text-center">${formatNum(row.kills)}</td>
                    <td class="text-center">${formatNum(row.deaths)}</td>
                    <td class="text-center">${formatNum(row.assists)}</td>
                    <td class="text-center">${formatNum(row.hs)}</td>
                    <td class="text-center">${formatPercent(row.hs_ratio)}</td>
                    <td class="text-center">${formatNum(row.first_kill)}</td>
                    <td class="text-center">${formatNum(row.first_death)}</td>
                    <td class="text-center">${formatNum(row.bomb_planted)}</td>
                    <td class="text-center">${formatNum(row.bomb_defused)}</td>
                    <td class="text-center">${formatNum(row.hltv)}</td>
                    <td class="text-center">${formatPercent(row.kast)}</td>
                    <td class="text-center">${formatNum(row.utl_dmg)}</td>
                    <td class="text-center">${formatNum(row.two_kills)}</td>
                    <td class="text-center">${formatNum(row.three_kills)}</td>
                    <td class="text-center">${formatNum(row.four_kills)}</td>
                    <td class="text-center">${formatNum(row.five_kills)}</td>
                    <td class="text-center">${row.matches ?? 'N/A'}</td>
                    <td class="text-center">${formatPercent(row.win_rate)}</td>
                    <td class="text-center">${formatNum(row.avg_clutches)}</td>
                    <td class="text-center">${formatNum(row.avg_clutches_won)}</td>
                    <td class="text-center">${formatPercent(row.clutch_success)}</td>
                `;
                tbody.appendChild(tr);
            });

            // console.log(`fillLast10Table: Finished processing ${data.length} rows.`); // Log finish processing // REMOVED LOG

            // Apply heatmap AFTER rows are in the DOM
            const gradient = [
                { percent: 0, color: '#EF4444' },   // Red-500
                { percent: 0.5, color: '#FDE68A' }, // Yellow-200 (the lighter one)
                { percent: 1, color: '#22C55E' }    // Green-500
            ];
            applyHeatmapToColumn(tbody.id, 1, gradient); // HLTV2 (index 1)
            applyHeatmapToColumn(tbody.id, 2, gradient); // ADR (index 2)
            applyHeatmapToColumn(tbody.id, 3, gradient); // K/D (index 3)
        }

        /**
         * Fetches Son Maç match stats from the local JSON file.
         */
        async function fetchSonMacData() {
            try {
                const response = await fetch(SONMAC_JSON_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();
                if (!data || !data.maps) {
                    throw new Error("Invalid data format received from JSON file.");
                }
                return data;
            } catch (err) {
                console.error('Failed to fetch Son Maç data:', err);
                showMessage(`Error loading Son Maç data: ${err.message}`, 'error');
                return null;
            }
        }

        // Function to fetch and render the Son Maç data
        async function loadAndRenderSonMacData() {
            const matchData = await fetchSonMacData();
            if (matchData) {
                // Populate creates the structure, including tbodies with originalData
                populateSonMacData(matchData);
                initSonMacTabs(); // Initialize tab click listeners

                // --- Apply heatmap and initial sort to the initially active tab --- 
                const firstActiveTab = document.querySelector('#map-tabs button.active');
                if (firstActiveTab) {
                    const contentId = firstActiveTab.getAttribute('aria-controls');
                    const contentDiv = document.getElementById(contentId);
                    if (contentDiv) {
                        const teamDivs = contentDiv.querySelectorAll('div.mb-6');
                        teamDivs.forEach(teamDiv => {
                            const tbody = teamDiv.querySelector('tbody');
                            if (tbody && tbody.id && tbody.dataset.originalData) {
                                let playersData = JSON.parse(tbody.dataset.originalData);
                                // Initial sort
                                sortData(playersData, 'hltv_2', 'desc');
                                // Render the body with sorted data for the first time
                                fillSonMacTableBody(tbody, playersData);
                                // Set initial header indicator
                                setInitialSortState(tbody, 'hltv_2', 'desc');
                            }
                        });
                    }
                }
            }
        }

        // Function to populate the Son Maç page with match data
        function populateSonMacData(data) {
            if (!data || !data.maps) return;
            
            // Get map tabs
            const mapTabs = document.querySelector('#map-tabs');
            mapTabs.innerHTML = ''; // Clear existing tabs
            
            // Create tabs for each map
            let isFirst = true;
            Object.keys(data.maps).forEach(mapName => {
                const li = document.createElement('li');
                li.className = 'mr-2';
                li.setAttribute('role', 'presentation');
                
                const button = document.createElement('button');
                button.id = `${mapName}-tab`;
                // Add the base class and the specific map tab class
                button.className = `tab-nav-item map-tab-button inline-block p-4 border-b-2 ${isFirst ? 'border-blue-500 active' : 'border-transparent'} rounded-t-lg hover:text-gray-600 hover:border-gray-300`;
                button.setAttribute('aria-controls', mapName);
                button.textContent = mapName;
                
                li.appendChild(button);
                mapTabs.appendChild(li);
                
                // Create/populate map content
                populateMapContent(mapName, data.maps[mapName], isFirst);
                
                if (isFirst) isFirst = false;
            });
            
            // Re-initialize tab functionality
            initSonMacTabs();
        }

        function populateMapContent(mapName, mapData, isActive) {
            const mapTabContent = document.getElementById('mapTabContent');
            
            // Create map div if it doesn't exist
            let mapDiv = document.getElementById(mapName);
            if (!mapDiv) {
                mapDiv = document.createElement('div');
                mapDiv.id = mapName;
                mapDiv.className = isActive ? 'active' : 'hidden';
                mapTabContent.appendChild(mapDiv);
            } else {
                mapDiv.innerHTML = ''; // Clear existing content
                mapDiv.className = isActive ? 'active' : 'hidden';
            }
            
            // Create scoreboard
            const scoreboardDiv = document.createElement('div');
            // Add overflow-x-auto to enable horizontal scroll if needed
            scoreboardDiv.className = 'flex justify-between md:justify-center md:gap-16 items-center mb-6 px-4 py-3 bg-gray-100 rounded-lg overflow-x-auto';
            scoreboardDiv.innerHTML = `
                <div class="text-center whitespace-nowrap"> 
                    <h3 class="text-lg font-bold">${mapData.team1.name}</h3> 
                    <div class="text-3xl font-extrabold text-blue-600">${mapData.team1.score}</div>
                </div>
                <div class="text-xl md:text-3xl font-semibold text-gray-500">vs</div> 
                <div class="text-center whitespace-nowrap"> 
                    <h3 class="text-lg font-bold">${mapData.team2.name}</h3> 
                    <div class="text-3xl font-extrabold text-green-600">${mapData.team2.score}</div>
                </div>
            `;
            mapDiv.appendChild(scoreboardDiv);
            
            // Create team1 section
            const team1Div = createTeamSection(mapName, mapData.team1, 'blue');
            mapDiv.appendChild(team1Div);
            
            // Create team2 section
            const team2Div = createTeamSection(mapName, mapData.team2, 'green');
            mapDiv.appendChild(team2Div);
        }

        function createTeamSection(mapName, teamData, color) {
            const teamDiv = document.createElement('div');
            teamDiv.className = 'mb-6';
            
            // Team heading
            const teamHeading = document.createElement('h3');
            teamHeading.className = `text-lg font-semibold text-${color}-600 mb-2 px-3`;
            teamHeading.textContent = teamData.name;
            teamDiv.appendChild(teamHeading);
            
            // Table container
            const tableContainer = document.createElement('div');
            tableContainer.className = 'overflow-x-auto';
            
            // Create table
            const table = document.createElement('table');
            table.className = 'styled-table min-w-full text-sm';
            
            // Table head - Add data-sort-key and sortable-header class
            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th class="sortable-header" data-sort-key="name">Oyuncu</th>
                    <th class="sortable-header" data-sort-key="hltv_2">HLTV2</th>
                    <th class="sortable-header" data-sort-key="adr">ADR</th>
                    <th class="sortable-header" data-sort-key="kd">K/D</th>
                    <th class="sortable-header" data-sort-key="mvp">MVP</th>
                    <th class="sortable-header" data-sort-key="kills">Kills</th>
                    <th class="sortable-header" data-sort-key="deaths">Deaths</th>
                    <th class="sortable-header" data-sort-key="assists">Assists</th>
                    <th class="sortable-header" data-sort-key="hs">HS</th>
                    <th class="sortable-header" data-sort-key="hs_ratio">HS/Kill ratio</th>
                    <th class="sortable-header" data-sort-key="first_kill">First Kill</th>
                    <th class="sortable-header" data-sort-key="first_death">First Death</th>
                    <th class="sortable-header" data-sort-key="bomb_planted">Bomb Planted</th>
                    <th class="sortable-header" data-sort-key="bomb_defused">Bomb Defused</th>
                    <th class="sortable-header" data-sort-key="hltv">HLTV</th>
                    <th class="sortable-header" data-sort-key="kast">KAST</th>
                    <th class="sortable-header" data-sort-key="utl_dmg">Utility Damage</th>
                    <th class="sortable-header" data-sort-key="two_kills">2 kills</th>
                    <th class="sortable-header" data-sort-key="three_kills">3 kills</th>
                    <th class="sortable-header" data-sort-key="four_kills">4 kills</th>
                    <th class="sortable-header" data-sort-key="five_kills">5 kills</th>
                    <th class="sortable-header" data-sort-key="score">Score</th>
                    <th class="sortable-header" data-sort-key="clutches">Nr of clutches</th>
                    <th class="sortable-header" data-sort-key="clutches_won">Clutches Won</th>
                </tr>
            `;
            table.appendChild(thead);
            
            // Table body
            const tbodyId = `sonmac-${mapName}-${teamData.name.replace(/\s+/g, '_').toLowerCase()}-${color}`;
            const tbody = document.createElement('tbody');
            tbody.id = tbodyId;
            tbody.dataset.originalData = JSON.stringify(teamData.players); // Store player data
            
            // DO NOT fill initially. It will be filled after sorting in loadAndRenderSonMacData
             
             table.appendChild(tbody);
             tableContainer.appendChild(table);
            teamDiv.appendChild(tableContainer); 
            return teamDiv;
        }

        // --- Event Listeners ---

        // Initial load: Fetch data and show the default page
        document.addEventListener('DOMContentLoaded', () => {
            showPage(DEFAULT_PAGE); // Show the initial page
            fetchStatsFromSheet(); // Fetch initial data
            loadAndRenderSeasonAvgTable(); // Fetch and render season average stats
            loadAndRenderLast10Table(); // Fetch and render last 10 games stats
            loadAndRenderNightAvgTable(); // Fetch and render nightly average stats
            loadAndRenderSonMacData(); // Fetch and render Son Maç data
            initSonMacTabs(); // Initialize tabs for Son Maç page
            loadAndRenderDuelloGrid(); // Added call to load Duello grid
            
            // Set initial navigation visibility based on screen size
            if (window.innerWidth >= 768) { // Tailwind's md breakpoint is 768px
                navLinksContainer.classList.remove('hidden', 'mobile-menu-active');
            } else {
                navLinksContainer.classList.add('hidden');
                navLinksContainer.classList.remove('mobile-menu-active');
                menuButton.setAttribute('aria-expanded', 'false');
                iconHamburger.classList.remove('hidden');
                iconClose.classList.add('hidden');
            }
        });

        // Update button click
        updateButton.addEventListener('click', fetchStatsFromSheet);

        // Player list clicks (for attendance changes via event delegation)
        playerListBody.addEventListener('click', handlePlayerListClick);

        // Navigation link clicks (using event delegation on the container)
        navLinksContainer.addEventListener('click', (event) => {
            const link = event.target.closest('.tab-nav-item');
            if (link && link.dataset.page) { // Check if it's a valid nav link with a page target
                event.preventDefault(); // Prevent default anchor link behavior
                const pageId = link.dataset.page;
                showPage(pageId);
                 // Placeholder: Fetch data for the newly selected tab if necessary
                 // loadTabDataIfNeeded(pageId);
            }
        });
        
        // --- Responsive menu fix: Ensure nav is visible on desktop after resizing from mobile ---
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 768) { // Tailwind's md breakpoint is 768px
                navLinksContainer.classList.remove('hidden', 'mobile-menu-active');
                menuButton.setAttribute('aria-expanded', 'false');
                iconHamburger.classList.remove('hidden');
                iconClose.classList.add('hidden');
            } else {
                navLinksContainer.classList.add('hidden');
                navLinksContainer.classList.remove('mobile-menu-active');
                menuButton.setAttribute('aria-expanded', 'false');
                iconHamburger.classList.remove('hidden');
                iconClose.classList.add('hidden');
            }
        });
        // Mobile menu button click
        menuButton.addEventListener('click', () => toggleMobileMenu());

        // Add JavaScript for tab functionality at the end of the script section
        // ... existing code ...

        // Add this to your DOMContentLoaded event listener or as a separate function
        function initSonMacTabs() {
            const mapTabs = document.querySelectorAll('#map-tabs button');
            const mapContents = document.querySelectorAll('#mapTabContent > div');
            
            mapTabs.forEach(tab => {
                tab.addEventListener('click', () => {

                    // Remove active classes from all tabs and contents
                    mapTabs.forEach(t => {
                        t.classList.remove('active', 'border-blue-500');
                        t.classList.add('border-transparent');
                    });
                    mapContents.forEach(c => c.classList.add('hidden'));
                    
                    // Add active class to clicked tab
                    tab.classList.add('active', 'border-blue-500');
                    tab.classList.remove('border-transparent');
                    
                    // Show corresponding content
                    const contentId = tab.getAttribute('aria-controls');
                    const contentDiv = document.getElementById(contentId);
                    if (contentDiv) {
                        contentDiv.classList.remove('hidden');

                        // --- Render table content for the selected map --- 
                        const teamDivs = contentDiv.querySelectorAll('div.mb-6');
                        teamDivs.forEach(teamDiv => {
                            const tbody = teamDiv.querySelector('tbody');
                            if (tbody && tbody.id && tbody.dataset.originalData) {
                                try {
                                    let playersData = JSON.parse(tbody.dataset.originalData);
                                    // Sort data (defaulting to HLTV2 desc)
                                    sortData(playersData, 'hltv_2', 'desc'); 
                                    // Fill the table body (this also applies heatmap)
                                    fillSonMacTableBody(tbody, playersData);
                                    // Set the initial sort state for the header
                                    setInitialSortState(tbody, 'hltv_2', 'desc');
                                } catch (e) {
                                    console.error(`Error processing data for tbody ${tbody.id}:`, e);
                                    tbody.innerHTML = '<tr><td colspan="24" class="text-center text-red-600">Error loading player data.</td></tr>';
                                }
                            } else {
                                console.error(`Could not find tbody, tbody.id, or originalData in a teamDiv within ${contentId}`);
                            }
                        });
                        // --- Heatmaps are now applied within fillSonMacTableBody ---
                        /* // REMOVED redundant heatmap application
                        // --- Re-apply heatmaps for both teams in this map ---
                        // Find both tbody ids for this map (team1-blue, team2-green)
                        const teamDivs = contentDiv.querySelectorAll('div.mb-6');

                        teamDivs.forEach(teamDiv => {
                            const tbody = teamDiv.querySelector('tbody');
                            if (tbody && tbody.id) {
                                // Apply heatmap directly (removed setTimeout)
                                const gradient = [
                                    { percent: 0, color: '#EF4444' },
                                    { percent: 0.5, color: '#FDE68A' },
                                    { percent: 1, color: '#22C55E' }
                                ];
                                applyHeatmapToColumn(tbody.id, 1, gradient); // HLTV2
                                applyHeatmapToColumn(tbody.id, 2, gradient); // ADR
                                applyHeatmapToColumn(tbody.id, 3, gradient); // K/D
                            } else {
                                console.error(`Could not find tbody or tbody.id in a teamDiv within ${contentId}`);
                            }
                        });
                        */
                    } else {
                        console.error(`Content div with ID ${contentId} not found!`);
                    }
                });
            });
        }

        /**
         * Interpolates between two hex colors.
         * @param {string} hex1 Start color (#RRGGBB)
         * @param {string} hex2 End color (#RRGGBB)
         * @param {number} factor Interpolation factor (0 to 1)
         * @returns {string} Interpolated hex color
         */
        function interpolateColor(hex1, hex2, factor) {
            const r1 = parseInt(hex1.substring(1, 3), 16);
            const g1 = parseInt(hex1.substring(3, 5), 16);
            const b1 = parseInt(hex1.substring(5, 7), 16);
            const r2 = parseInt(hex2.substring(1, 3), 16);
            const g2 = parseInt(hex2.substring(3, 5), 16);
            const b2 = parseInt(hex2.substring(5, 7), 16);

            const r = Math.round(r1 + factor * (r2 - r1));
            const g = Math.round(g1 + factor * (g2 - g1));
            const b = Math.round(b1 + factor * (b2 - b1));

            const toHex = (c) => c.toString(16).padStart(2, '0');
            return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
        }

        /**
         * Calculates color based on value within a range and gradient stops.
         * @param {number} value The value to map.
         * @param {number} min Minimum value in the range.
         * @param {number} max Maximum value in the range.
         * @param {Array<{percent: number, color: string}>} gradientStops Array of stops (e.g., [{percent: 0, color: '#ff0000'}, {percent: 1, color: '#00ff00'}])
         * @returns {string} Calculated hex color.
         */
        function calculateColor(value, min, max, gradientStops) {
            if (max === min || isNaN(value) || value === null) {
                // Return middle color if range is zero or value is invalid
                const middleIndex = Math.floor(gradientStops.length / 2);
                return gradientStops[middleIndex]?.color || '#ffffff'; // Fallback to white
            }
            // Clamp value to min/max to handle potential outliers slightly outside fetched range
            const clampedValue = Math.max(min, Math.min(max, value));
            const percent = (clampedValue - min) / (max - min);

            // Find the two stops the percentage falls between
            let stop1 = gradientStops[0];
            let stop2 = gradientStops[gradientStops.length - 1];

            for (let i = 0; i < gradientStops.length - 1; i++) {
                if (percent >= gradientStops[i].percent && percent <= gradientStops[i + 1].percent) {
                    stop1 = gradientStops[i];
                    stop2 = gradientStops[i + 1];
                    break;
                }
            }

            // Calculate the factor for interpolation between the two stops
            const rangePercent = stop2.percent - stop1.percent;
            const factor = (rangePercent === 0) ? 0 : (percent - stop1.percent) / rangePercent;

            return interpolateColor(stop1.color, stop2.color, factor);
        }

        /**
         * Calculates relative luminance of a hex color.
         * @param {string} hexColor (#RRGGBB)
         * @returns {number} Luminance value (0 to 1)
         */
        function getLuminance(hexColor) {
            const rgb = parseInt(hexColor.substring(1), 16);
            const r = (rgb >> 16) & 0xff;
            const g = (rgb >>  8) & 0xff;
            const b = (rgb >>  0) & 0xff;

            const sR = r / 255;
            const sG = g / 255;
            const sB = b / 255;

            const R = (sR <= 0.03928) ? sR / 12.92 : Math.pow((sR + 0.055) / 1.055, 2.4);
            const G = (sG <= 0.03928) ? sG / 12.92 : Math.pow((sG + 0.055) / 1.055, 2.4);
            const B = (sB <= 0.03928) ? sB / 12.92 : Math.pow((sB + 0.055) / 1.055, 2.4);

            return 0.2126 * R + 0.7152 * G + 0.0722 * B;
        }

        /**
         * Determines if white or black text provides better contrast against a background color.
         * Uses WCAG contrast ratio recommendations (simplified: chooses based on luminance threshold).
         * @param {string} bgColorHex (#RRGGBB)
         * @returns {string} '#ffffff' (white) or '#000000' (black)
         */
        function calculateTextColor(bgColorHex) {
            const luminance = getLuminance(bgColorHex);
            // Threshold slightly adjusted from pure 0.5 for better aesthetics in some cases
            return (luminance > 0.4) ? '#000000' : '#ffffff';
        }


        /**
         * Applies heatmap colors to badge spans within a specific table column.
         * @param {string} tbodyId The ID of the table body.
         * @param {number} columnIndex The 0-based index of the column.
         * @param {Array<{percent: number, color: string}>} gradientStops Color gradient definition.
         */
        function applyHeatmapToColumn(tbodyId, columnIndex, gradientStops) {
            const tbody = document.getElementById(tbodyId);
            if (!tbody) {
                console.error(`applyHeatmapToColumn: tbody with id '${tbodyId}' not found.`);
                return;
            }

            // Select the SPAN inside the TD at the correct index (nth-child is 1-based)
            const spans = tbody.querySelectorAll(`tr td:nth-child(${columnIndex + 1}) span.stat-badge`);
            if (spans.length === 0) {
                 return; // No spans to color
            }

            const values = [];
            spans.forEach(span => {
                const textContent = span.textContent; // Get text content first
                const value = parseFloat(textContent);
                 if (!isNaN(value)) {
                    values.push(value);
                    // Store value on span for easy retrieval later, avoiding re-parsing
                    span.dataset.value = value;
                } else {
                     span.dataset.value = 'NaN'; // Mark as invalid
                }
            });

            if (values.length === 0) return; // No valid numeric values found

            const minVal = Math.min(...values);
            const maxVal = Math.max(...values);

            spans.forEach(span => {
                const value = parseFloat(span.dataset.value); // Retrieve stored value
                if (!isNaN(value)) {
                    const bgColor = calculateColor(value, minVal, maxVal, gradientStops);
                    const textColor = calculateTextColor(bgColor);
                    // Add !important to override potential stylesheet rules
                    span.style.setProperty('background-color', bgColor, 'important');
                    span.style.setProperty('color', textColor, 'important');
                } else {
                    // Optional: Style invalid values differently (e.g., gray)
                    // Add !important here too for consistency if needed
                    span.style.setProperty('background-color', '#e5e7eb', 'important'); // Light gray
                    span.style.setProperty('color', '#4b5563', 'important');      // Darker gray text
                }
            });
        }

        // NEW function to fill just the tbody for SonMac tables
        function fillSonMacTableBody(tbody, playersData) {
            // Note: originalData for SonMac is stored when the section is created
            
            tbody.innerHTML = ''; // Clear existing rows

            // Render rows from the provided playersData array
            playersData.forEach(player => {
                const tr = document.createElement('tr');
                const formatNum = (num, decimals = 2) => (typeof num === 'number' ? num.toFixed(decimals) : 'N/A');
                const formatPercent = (num) => (typeof num === 'number' ? num.toFixed(2) + '%' : 'N/A');
                
                tr.innerHTML = `
                    <td class="font-medium text-gray-900 whitespace-nowrap">${player.name || 'N/A'}</td>
                    <td class="stat-badge-cell"><span class="stat-badge">${formatNum(player.hltv_2)}</span></td>
                    <td class="stat-badge-cell"><span class="stat-badge">${formatNum(player.adr, 0)}</span></td>
                    <td class="stat-badge-cell"><span class="stat-badge">${formatNum(player.kd)}</span></td>
                    <td class="text-center">${formatNum(player.mvp)}</td>
                    <td class="text-center">${formatNum(player.kills, 0)}</td>
                    <td class="text-center">${formatNum(player.deaths, 0)}</td>
                    <td class="text-center">${formatNum(player.assists, 0)}</td>
                    <td class="text-center">${formatNum(player.hs, 0)}</td>
                    <td class="text-center">${formatNum(player.hs_ratio)}</td>
                    <td class="text-center">${formatNum(player.first_kill, 0)}</td>
                    <td class="text-center">${formatNum(player.first_death, 0)}</td>
                    <td class="text-center">${formatNum(player.bomb_planted, 0)}</td>
                    <td class="text-center">${formatNum(player.bomb_defused, 0)}</td>
                    <td class="text-center">${formatNum(player.hltv)}</td> 
                    <td class="text-center">${formatPercent(player.kast)}</td>
                    <td class="text-center">${formatNum(player.utl_dmg, 0)}</td>
                    <td class="text-center">${formatNum(player.two_kills, 0)}</td>
                    <td class="text-center">${formatNum(player.three_kills, 0)}</td>
                    <td class="text-center">${formatNum(player.four_kills, 0)}</td>
                    <td class="text-center">${formatNum(player.five_kills, 0)}</td>
                    <td class="text-center">${formatNum(player.score, 0)}</td>
                    <td class="text-center">${formatNum(player.clutches, 0)}</td>
                    <td class="text-center">${formatNum(player.clutches_won, 0)}</td>
                `;
                tbody.appendChild(tr);
            });

            // Re-apply heatmap AFTER rows are in the DOM
             const gradient = [
                { percent: 0, color: '#EF4444' },
                { percent: 0.5, color: '#FDE68A' },
                { percent: 1, color: '#22C55E' }
            ];
            applyHeatmapToColumn(tbody.id, 1, gradient); // HLTV2
            applyHeatmapToColumn(tbody.id, 2, gradient); // ADR
            applyHeatmapToColumn(tbody.id, 3, gradient); // K/D
        }

        // --- Sorting Logic ---
        // Helper function for actual sorting
        function sortData(data, sortKey, sortDir) {
             data.sort((a, b) => {
                let valA = a[sortKey];
                let valB = b[sortKey];

                // Basic type checking (treat null/undefined as lowest)
                valA = valA === null || valA === undefined ? -Infinity : valA;
                valB = valB === null || valB === undefined ? -Infinity : valB;

                // Attempt numeric comparison first
                const numA = parseFloat(valA);
                const numB = parseFloat(valB);

                if (!isNaN(numA) && !isNaN(numB)) {
                    // Numeric sort
                    return sortDir === 'asc' ? numA - numB : numB - numA;
                } else {
                    // String sort (case-insensitive)
                    const strA = String(valA).toLowerCase();
                    const strB = String(valB).toLowerCase();
                    if (strA < strB) return sortDir === 'asc' ? -1 : 1;
                    if (strA > strB) return sortDir === 'asc' ? 1 : -1;
                    return 0;
                }
            });
        }
        
        // Helper function to set header classes and store state
        function setSortState(tbody, header, sortKey, sortDir) {
            const thead = tbody.closest('table').querySelector('thead');
             // Clear existing sort indicators
            thead.querySelectorAll('.sortable-header').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc', 'sort-active');
            });
            // Add indicator and active class to clicked header
            header.classList.add(sortDir === 'asc' ? 'sort-asc' : 'sort-desc');
            header.classList.add('sort-active');

            // Store current sort state
            tbody.dataset.currentSortKey = sortKey;
            tbody.dataset.currentSortDir = sortDir;
        }
        
        // Helper function to set the *initial* sort state on load
        function setInitialSortState(tbody, defaultSortKey, defaultSortDir) {
             const thead = tbody.closest('table').querySelector('thead');
             const defaultHeader = thead.querySelector(`.sortable-header[data-sort-key="${defaultSortKey}"]`);
             if (defaultHeader) {
                 setSortState(tbody, defaultHeader, defaultSortKey, defaultSortDir);
             }
        }

        function handleSortClick(event) {
            const header = event.target.closest('.sortable-header');
            if (!header) return; 

            const sortKey = header.dataset.sortKey;
            const table = header.closest('table');
            const tbody = table.querySelector('tbody');
            const thead = table.querySelector('thead');

            if (!tbody || !tbody.dataset.originalData) { 
                console.error('Could not find table body or original data for sorting.');
                return;
            }

            // Parse the original, UNsorted data
            const originalData = JSON.parse(tbody.dataset.originalData);
            // Create a COPY to sort
            let dataToSort = [...originalData]; // Use spread syntax for a shallow copy

            // Determine sort direction
            const currentSortKey = tbody.dataset.currentSortKey;
            const currentSortDir = tbody.dataset.currentSortDir;
            let newSortDir = 'desc'; 
            if (currentSortKey === sortKey && currentSortDir === 'desc') {
                newSortDir = 'asc';
            }

            // --- Sorting --- 
            sortData(dataToSort, sortKey, newSortDir); // Sort the COPY

            // --- Re-render table --- 
            // Pass the SORTED COPY to the fill function
            if (tbody.id === 'season-avg-table-body') {
                fillSeasonAvgTable(dataToSort, tbody);
            } else if (tbody.id === 'last10-table-body') {
                fillLast10Table(dataToSort, tbody);
            } else if (tbody.id === 'night-avg-table-body') {
                fillNightAvgTable(dataToSort, tbody);
            } else if (tbody.id.startsWith('sonmac-')) {
                fillSonMacTableBody(tbody, dataToSort);
            }

            // --- Update header indicators --- 
            setSortState(tbody, header, sortKey, newSortDir); 
        }

        // Add ONE event listener to the main content area for all table sorts
        pageContentArea.addEventListener('click', handleSortClick);

        // Add event listener for Duello circle clicks (for mobile tooltips)
        // Corrected the target element ID to '#duello-table'
        const duelloTable = document.getElementById('duello-table'); 
        if (duelloTable) { // Ensure the element exists before adding listener
            duelloTable.addEventListener('click', (event) => {
                const clickedCircle = event.target.closest('.duello-circle');
                if (clickedCircle) {
                    const killer = clickedCircle.dataset.killer;
                    const killed = clickedCircle.dataset.killed;
                    const count = clickedCircle.dataset.count;
                    if (killer && killed && count) {
                        const message = `${killer} killed ${killed} ${count} times`;
                        // Use a neutral/info style if available, otherwise success
                        showMessage(message, 'success', 3000); 
                    }
                }
            });
        }

        // Add JavaScript for tab functionality at the end of the script section

        // Function to fetch and render the nightly average table
        async function loadAndRenderNightAvgTable() {
             console.log("loadAndRenderNightAvgTable: Starting"); // Log start
             const stats = await fetchNightAvgStats();
             console.log("loadAndRenderNightAvgTable: Fetched stats:", stats?.length > 0 ? `${stats.length} rows` : stats); // Log fetched data
             if (stats && stats.length > 0) {
                 // Initial sort - NOTE: Uses keys with spaces from the JSON
                 sortData(stats, 'HLTV 2', 'desc');
                 // Render
                 fillNightAvgTable(stats);
                 // Set initial header indicator
                 const tbody = document.getElementById('night-avg-table-body');
                 setInitialSortState(tbody, 'HLTV 2', 'desc');
             }
        }

        // Function to fill the nightly average table with data
        function fillNightAvgTable(data, tbody) {
             console.log("fillNightAvgTable: Starting", data ? `${data.length} rows` : data); // Log start and data
             // Get tbody if not provided
            tbody = tbody || document.getElementById('night-avg-table-body');
             if (!tbody) {
                console.error("fillNightAvgTable: tbody with id 'night-avg-table-body' not found.");
                return;
            }
             console.log("fillNightAvgTable: Found tbody", tbody.id); // Log tbody found

             // Store original data ONLY if it doesn't exist (first load)
             if (!tbody.dataset.originalData) {
                 tbody.dataset.originalData = JSON.stringify(data);
             }

            tbody.innerHTML = ''; // Clear existing rows
            console.log("fillNightAvgTable: Cleared tbody"); // Log tbody cleared

             // Render rows from the provided data array
            data.forEach((row, index) => {
                 if (index === 0) {
                     console.log("fillNightAvgTable: Processing first row:", row); // Log first row data
                 }
                // Helper to safely format numbers or return 'N/A'
                const formatNum = (num, decimals = 2) => (typeof num === 'number' ? num.toFixed(decimals) : 'N/A');
                const formatPercent = (num) => (typeof num === 'number' ? num.toFixed(2) + '%' : 'N/A');

                const tr = document.createElement('tr');
                // Apply ONLY stat-badge class to spans in the HTML string
                tr.innerHTML = `
                    <td class="font-medium text-gray-900 whitespace-nowrap">${row.name || 'N/A'}</td>
                    <td class="stat-badge-cell"><span class="stat-badge">${formatNum(row["HLTV 2"])}</span></td>
                    <td class="stat-badge-cell"><span class="stat-badge">${formatNum(row["ADR"], 0)}</span></td>
                    <td class="stat-badge-cell"><span class="stat-badge">${formatNum(row["K/D"])}</span></td>
                    <td class="stat-badge-cell"><span class="stat-badge">${formatNum(row["HLTV2 DIFF"])}</span></td> 
                    <td class="stat-badge-cell"><span class="stat-badge">${formatNum(row["ADR DIFF"])}</span></td> 
                    <td class="text-center">${formatNum(row["MVP"])}</td>
                    <td class="text-center">${formatNum(row["Kills"])}</td>
                    <td class="text-center">${formatNum(row["Deaths"])}</td>
                    <td class="text-center">${formatNum(row["Assists"])}</td>
                    <td class="text-center">${formatNum(row["HS"])}</td>
                    <td class="text-center">${formatPercent(row["HS/Kill ratio"])}</td>
                    <td class="text-center">${formatNum(row["First Kill"])}</td>
                    <td class="text-center">${formatNum(row["First Death"])}</td>
                    <td class="text-center">${formatNum(row["Bomb Planted"])}</td>
                    <td class="text-center">${formatNum(row["Bomb Defused"])}</td>
                    <td class="text-center">${formatNum(row["HLTV"])}</td>
                    <td class="text-center">${formatPercent(row["KAST"])}</td>
                    <td class="text-center">${formatNum(row["Utility Damage"])}</td>
                    <td class="text-center">${formatNum(row["2 kills"])}</td>
                    <td class="text-center">${formatNum(row["3 kills"])}</td>
                    <td class="text-center">${formatNum(row["4 kills"])}</td>
                    <td class="text-center">${formatNum(row["5 kills"])}</td>
                    <td class="text-center">${row["Nr of Matches"] ?? 'N/A'}</td>
                    <td class="text-center">${formatNum(row["Clutch Opportunity"], 0)}</td> 
                    <td class="text-center">${formatNum(row["Clutches Won"], 0)}</td> 
                `;
                tbody.appendChild(tr);
            });

             console.log(`fillNightAvgTable: Finished processing ${data.length} rows.`); // Log finish processing

            // Apply heatmap AFTER rows are in the DOM
            const gradient = [
                { percent: 0, color: '#EF4444' },   // Red-500
                { percent: 0.5, color: '#FDE68A' }, // Yellow-200
                { percent: 1, color: '#22C55E' }    // Green-500
            ];
            applyHeatmapToColumn(tbody.id, 1, gradient); // HLTV2 (index 1)
            applyHeatmapToColumn(tbody.id, 2, gradient); // ADR (index 2)
            applyHeatmapToColumn(tbody.id, 3, gradient); // K/D (index 3)
            applyHeatmapToColumn(tbody.id, 4, gradient); // HLTV2 DIFF (new index 4)
            applyHeatmapToColumn(tbody.id, 5, gradient); // ADR DIFF (new index 5)
        }

        // --- Duello Son Maç Logic --- NEW SECTION

        /**
         * Fetches Duello Son Maç data from the local JSON file.
         */
        async function fetchDuelloSonMacData() {
            try {
                const response = await fetch(DUELLO_JSON_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();
                // Basic validation
                if (!data || !data.playerRows || !data.playerCols || !data.duels) {
                    throw new Error("Invalid data format received from Duello JSON file.");
                }
                return data;
            } catch (err) {
                console.error('Failed to fetch Duello Son Maç data:', err);
                showMessage(`Error loading Duello data: ${err.message}`, 'error');
                return null; // Return null on error
            }
        }

        /**
         * Renders the Duello Son Maç grid.
         * @param {object} data - The duel data object containing playerRows, playerCols, and duels.
         */
        function renderDuelloSonMacGrid(data) {
            const table = document.getElementById('duello-table');
            
            if (!table) {
                console.error("Duello table not found!");
                return;
            }
            if (!data) {
                table.innerHTML = '<thead><tr><th></th><th colspan="12" class="text-center p-4 text-red-500">Failed to load Duello data.</th></tr></thead>';
                return;
            }
            
            // Clear previous content
            table.innerHTML = '';
            
            const { playerRows, playerCols, duels } = data;
            
            // Create table header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            // Add empty corner cell
            const cornerCell = document.createElement('th');
            cornerCell.className = 'border bg-gray-50 p-3 font-semibold text-center';
            cornerCell.style.position = 'sticky';
            cornerCell.style.left = '0';
            cornerCell.style.top = '0';
            cornerCell.style.zIndex = '20';
            cornerCell.style.minWidth = '120px';
            // cornerCell.textContent = 'Kill \\ Death'; // Text removed as requested
            headerRow.appendChild(cornerCell);
            
            // Add column headers
            playerCols.forEach(colName => {
                const th = document.createElement('th');
                th.className = 'border bg-gray-50 p-3 font-semibold text-center';
                th.style.position = 'sticky';
                th.style.top = '0';
                th.style.zIndex = '10';
                th.style.minWidth = '100px';
                th.textContent = colName;
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create table body
            const tbody = document.createElement('tbody');
            
            // Create rows
            playerRows.forEach(rowName => {
                const tr = document.createElement('tr');
                
                // Add row header (player name)
                const th = document.createElement('th');
                th.className = 'border bg-gray-50 p-3 font-semibold text-left';
                th.style.position = 'sticky';
                th.style.left = '0';
                th.style.zIndex = '10';
                th.textContent = rowName;
                tr.appendChild(th);
                
                // Add data cells
                playerCols.forEach(colName => {
                    const td = document.createElement('td');
                    td.className = 'border p-2 text-center';
                    td.style.height = '70px';
                    td.style.verticalAlign = 'middle';
                    
                    const duelData = duels[rowName]?.[colName];
                    
                    if (rowName === colName) {
                        // Self vs self - gray background
                        td.style.backgroundColor = '#f3f4f6';
                    } else if (duelData && (duelData.kills > 0 || duelData.deaths > 0)) {
                        // Set td properties - enforce perfect square shape
                        const cellSize = 90; // Fixed size for all cells
                        td.style.width = `${cellSize}px`;
                        td.style.height = `${cellSize}px`;
                        td.style.minWidth = `${cellSize}px`;
                        td.style.maxWidth = `${cellSize}px`;
                        td.style.minHeight = `${cellSize}px`;
                        td.style.maxHeight = `${cellSize}px`;
                        td.style.padding = '0';
                        td.style.position = 'relative';
                        td.style.overflow = 'hidden';
                        td.style.backgroundColor = '#fff';
                        td.style.boxSizing = 'border-box'; // Ensure padding/border are included in size
                        
                        // Calculate diagonal length using Pythagorean theorem
                        const diagonalLength = Math.ceil(Math.sqrt(2 * cellSize * cellSize));
                        
                        // Create actual diagonal line element
                        const diagonalLine = document.createElement('div');
                        diagonalLine.style.position = 'absolute';
                        diagonalLine.style.width = `${diagonalLength}px`; // Dynamic length based on cell size
                        diagonalLine.style.height = '1px';
                        diagonalLine.style.backgroundColor = '#ccc';
                        diagonalLine.style.top = '50%';
                        diagonalLine.style.left = '50%';
                        diagonalLine.style.transform = 'translate(-50%, -50%) rotate(45deg)';
                        diagonalLine.style.transformOrigin = 'center center'; // Explicitly set origin
                        diagonalLine.style.zIndex = '1';
                        td.appendChild(diagonalLine);
                        
                        // Determine circle colors based on K/D (original comparison)
                        let topColorClass = 'bg-yellow-500'; // Default to yellow
                        let bottomColorClass = 'bg-yellow-500';
                        
                        if (duelData.kills > duelData.deaths) { // rowPlayer killed colPlayer more
                            topColorClass = 'bg-red-600';   // colPlayer's kills (deaths for rowPlayer) - Red
                            bottomColorClass = 'bg-green-600'; // rowPlayer's kills - Green
                        } else if (duelData.deaths > duelData.kills) { // colPlayer killed rowPlayer more
                            topColorClass = 'bg-green-600'; // colPlayer's kills (deaths for rowPlayer) - Green
                            bottomColorClass = 'bg-red-600';   // rowPlayer's kills - Red
                        }
                        
                        // Create the Top-Right Circle (Represents colPlayer killing rowPlayer)
                        const topRightCircle = document.createElement('div');
                        topRightCircle.className = `${topColorClass} duello-circle text-white font-bold rounded-full flex items-center justify-center cursor-pointer`;
                        topRightCircle.style.position = 'absolute';
                        topRightCircle.style.top = '10px';
                        topRightCircle.style.right = '15px';
                        topRightCircle.style.width = '36px';
                        topRightCircle.style.height = '36px';
                        topRightCircle.textContent = duelData.deaths; // Show deaths count (colPlayer kills)
                        // Add data attributes and title
                        topRightCircle.dataset.killer = colName;
                        topRightCircle.dataset.killed = rowName;
                        topRightCircle.dataset.count = duelData.deaths;
                        topRightCircle.title = `${colName} killed ${rowName} ${duelData.deaths} times`;
                        td.appendChild(topRightCircle);
                        
                        // Create the Bottom-Left Circle (Represents rowPlayer killing colPlayer)
                        const bottomLeftCircle = document.createElement('div');
                        bottomLeftCircle.className = `${bottomColorClass} duello-circle text-white font-bold rounded-full flex items-center justify-center cursor-pointer`;
                        bottomLeftCircle.style.position = 'absolute';
                        bottomLeftCircle.style.bottom = '10px';
                        bottomLeftCircle.style.left = '15px';
                        bottomLeftCircle.style.width = '36px';
                        bottomLeftCircle.style.height = '36px';
                        bottomLeftCircle.textContent = duelData.kills; // Show kills count (rowPlayer kills)
                        // Add data attributes and title
                        bottomLeftCircle.dataset.killer = rowName;
                        bottomLeftCircle.dataset.killed = colName;
                        bottomLeftCircle.dataset.count = duelData.kills;
                        bottomLeftCircle.title = `${rowName} killed ${colName} ${duelData.kills} times`;
                        td.appendChild(bottomLeftCircle);
                    } else {
                        td.className += ' text-gray-400';
                        td.textContent = '-';
                    }
                    
                    tr.appendChild(td);
                });
                
                tbody.appendChild(tr);
            });
            
            table.appendChild(tbody);
        }

        /**
         * Loads and renders the Duello Son Maç grid.
         */
        async function loadAndRenderDuelloGrid() {
            const duelloData = await fetchDuelloSonMacData();
            renderDuelloSonMacGrid(duelloData);
        }

        // --- End Duello Son Maç Logic ---

    </script>
</body>
</html>
