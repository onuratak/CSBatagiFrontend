<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS2 Stats Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="table-styles.css">
    <style>
        /* Use Inter font */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            color: #1f2937; /* Darker gray text */
        }

        /* --- General Styles --- */
        /* Hide inactive page content */
        .page-content.hidden {
            display: none;
        }
        /* Ensure hidden class works */
        .hidden {
           display: none !important; /* Use important to override potential inline styles if needed */
        }

        /* Simple spinner (used for button) */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            width: 20px;
            height: 20px;
            animation: spin 1s ease-in-out infinite;
            display: inline-block;
            margin-left: 10px;
            vertical-align: middle;
        }

        /* Wheel spinner (SVG Container - for "Teker Döndü") */
        .wheel-spinner {
            display: inline-block;
            width: 30px; /* Adjust size as needed */
            height: 30px;
            /* Removed border properties */
            animation: spin 8s linear infinite; /* Apply spin animation, maybe slightly slower */
            vertical-align: middle; /* Align with text */
            margin-left: 0.5rem; /* Add some space */
            /* Color is now set dynamically via JS */
            /* color: #4b5563; */ /* Default color removed */
        }
        /* Ensure SVG inside fills the container */
        .wheel-spinner svg {
             width: 100%;
             height: 100%;
        }


        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* --- Table Styles (Desktop Default) --- */
        th, td {
            /* Default padding for desktop view */
            padding: 12px 16px; /* Equivalent to py-3 px-4 */
            text-align: left;
            vertical-align: middle;
            /* border-bottom will be handled by Tailwind on the table/tbody or specific rules */
        }
        /* Header specific styles (if needed beyond default th, td) */
        th {
             font-weight: 600;
        }

        /* Rules from table-styles.css will override these for tables with .styled-table class */

        /* --- Status Badge Style (Keep for non-table badges if needed) --- */
        /* Status badge styles are now in table-styles.css */

        /* --- Responsive adjustments for mobile (max-width: 640px) --- */
        @media (max-width: 640px) {
            /* Mobile styles are now in table-styles.css */
        }

        /* --- Info Panel Styles (Light Theme) --- */
        /* Info panel styles are now in table-styles.css */

        /* --- Tab Navigation Styles (Light Theme) --- */
        .tab-nav-item {
            padding: 0.75rem 1rem; /* Adjusted padding slightly */
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            color: #6b7280; /* Default tab color (gray) */
            font-weight: 500;
            white-space: nowrap; /* Prevent wrapping */
            display: inline-block; /* Ensure proper spacing and border */
        }
        .tab-nav-item:hover {
            color: #1f2937; /* Darker color on hover */
            border-bottom-color: #d1d5db; /* Subtle border on hover */
        }
        .tab-nav-item.active {
            color: #2563eb; /* Active tab color (blue) */
            border-bottom-color: #2563eb; /* Active tab border color */
            font-weight: 600;
        }

        /* --- Mobile Navigation Styles --- */
        /* Container when mobile menu is active */
        #main-nav-links.mobile-menu-active {
            display: flex;
            flex-direction: column;
            position: absolute;
            top: 100%; /* Position below the header */
            left: 0;
            right: 0;
            background-color: white;
            z-index: 20;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            border-radius: 0 0 0.375rem 0.375rem; /* rounded-b-md */
        }
        /* Individual links in mobile menu */
        #main-nav-links.mobile-menu-active .tab-nav-item {
            display: block; /* Make links block level */
            padding: 0.75rem 1rem; /* Consistent padding */
            border-bottom: 1px solid #e5e7eb; /* Separator */
            border-left: 3px solid transparent; /* For active state indicator */
            border-bottom-color: #e5e7eb; /* Override bottom border from desktop */
            color: #374151; /* Default text color */
            font-weight: 500;
        }
        #main-nav-links.mobile-menu-active .tab-nav-item:last-child {
            border-bottom: none; /* Remove border from last item */
        }
        /* Active link style in mobile menu */
        #main-nav-links.mobile-menu-active .tab-nav-item.active {
            color: #2563eb; /* Active tab color (blue) */
            border-left-color: #2563eb; /* Active tab border color */
            background-color: #eff6ff; /* Light blue background (blue-50) */
            border-bottom-color: #e5e7eb !important; /* Ensure bottom border remains consistent */
            font-weight: 600;
        }

        /* --- Basic Button Style (Light Theme) --- */
        .action-button {
            background-color: #2563eb; /* Blue */
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 0.375rem; /* rounded-md */
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-weight: 500;
            display: inline-flex; /* Align spinner correctly */
            align-items: center;
            justify-content: center;
        }
        .action-button:hover {
            background-color: #1d4ed8; /* Darker Blue */
        }
        .action-button:disabled {
            background-color: #9ca3af; /* Gray when disabled */
            cursor: not-allowed;
        }
        .action-button:focus {
             outline: 2px solid transparent;
             outline-offset: 2px;
             box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.5); /* Ring focus */
        }


        /* --- Message Area (Light Theme) --- */
        #message-area {
            margin-top: 1rem;
            padding: 0.75rem 1.25rem;
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 500;
            border-width: 1px;
            border-style: solid;
            max-width: 42rem; /* max-w-lg */
            margin-left: auto;
            margin-right: auto;
            text-align: center;
        }
        #message-area.success {
            background-color: #dcfce7; color: #166534; border-color: #86efac; /* Green */
        }
        #message-area.error {
            background-color: #fee2e2; color: #991b1b; border-color: #fca5a5; /* Red */
        }

        /* --- General Page Content Container Style --- */
        .page-content-container {
            background-color: #ffffff;
            padding: 1.5rem; /* p-6 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); /* shadow-sm */
            border: 1px solid #e5e7eb; /* border-gray-200 */
        }

        /* --- Attendance Control Styles --- */
        /* Attendance control styles are now in table-styles.css */

        /* --- Player Status Table Styles --- */
        /* Player status table styles are now in table-styles.css */
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="container mx-auto max-w-7xl"> <header class="relative mb-6">
            <div class="flex justify-between items-center border-b border-gray-300 pb-3">
                <div class="flex items-center">
                    <img src="images/BatakLogo.png"
                         alt="Gaming Group Logo"
                         class="h-10 w-10 mr-2 object-contain"
                         onerror="this.onerror=null; this.src='https://placehold.co/40x40/e0e0e0/333?text=Logo';">
                    <h1 class="text-2xl md:text-3xl font-bold text-blue-700">CS Batağı Gururla Sunar</h1>
                </div>
                <button id="menu-button" type="button" class="md:hidden p-2 inline-flex items-center justify-center rounded-md text-gray-500 hover:text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500" aria-controls="main-nav-links" aria-expanded="false">
                    <span class="sr-only">Open main menu</span>
                    <svg id="icon-hamburger" class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                    <svg id="icon-close" class="hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <nav id="main-nav-links" class="sm:hidden md:flex md:flex-wrap md:items-center md:border-b md:border-gray-300 md:-mb-px md:mt-2" aria-label="Main navigation">
        <a class="tab-nav-item" data-page="attendance" href="#">Attendance</a>
        <a class="tab-nav-item" data-page="batak_domination" href="#">Batak Domination</a>
        <a class="tab-nav-item" data-page="sonmac" href="#">Son Maç</a>
        <a class="tab-nav-item" data-page="gece_ortalama" href="#">Gece Ortalaması</a>
        <a class="tab-nav-item" data-page="last10" href="#">Son 10 Ortalaması</a>
        <a class="tab-nav-item" data-page="season_avg" href="#">Sezon Ortalaması</a>
    </nav>
        </header>

        <div id="message-area" class="hidden" role="alert" aria-live="polite"></div>

        <div id="page-content-area">

            <div id="page-attendance" class="page-content">
                <div class="text-center mb-6">
                    <button id="update-stats-button" class="action-button">
                        Update Attendance from Sheet
                        <span id="spinner" class="spinner hidden"></span>
                    </button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8">
                    <div class="lg:col-span-2 page-content-container overflow-x-auto"> <h2 class="text-2xl font-semibold mb-1 text-blue-600">Player Status</h2>
                        <div id="attendance-summary" class="text-lg font-semibold mb-4 flex items-center justify-center text-center px-4 py-2 rounded-md transition-colors duration-300">
                            <span id="summary-text">Loading summary...</span>
                            <span id="teker-dondu-indicator" class="wheel-spinner hidden" title="Teker Döndü!">
                                <svg 
                                height="40px" width="40px" version="1.1" id="_x32_" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" xml:space="preserve" fill="#000000"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <style type="text/css"> .st0{fill:#000000;} </style> <g> <path class="st0" d="M498.842,256c0-1.092-0.065-2.169-0.08-3.277c4.418-1.182,8.836-2.436,13.238-3.739 c-0.348-12.057-1.489-24.098-3.52-36.002c-4.556-0.445-9.136-0.809-13.708-1.124c-3.318-18.046-8.594-35.411-15.666-51.838 c3.609-2.768,7.186-5.632,10.762-8.529c-4.96-11.013-10.657-21.687-17.099-31.882c-4.369,1.343-8.731,2.767-13.085,4.232 c-9.913-15.253-21.476-29.318-34.463-41.941c2.274-3.965,4.636-7.858,6.821-11.896c-8.764-8.286-18.11-15.949-27.934-22.957 c-3.544,2.929-6.886,6.004-10.325,8.999c-14.841-10.254-30.904-18.871-47.889-25.628c0.599-4.548,1.125-9.112,1.594-13.676 c-11.272-4.322-22.884-7.818-34.65-10.504c-2.153,4.079-4.224,8.133-6.24,12.219c-16.33-3.456-33.25-5.308-50.599-5.308 c-1.158,0-2.29,0.065-3.447,0.097C251.355,8.82,250.279,4.394,248.968,0c-12.041,0.348-24.082,1.489-35.985,3.52 c-0.445,4.564-0.81,9.127-1.125,13.708c-18.069,3.318-35.41,8.594-51.837,15.65c-2.792-3.601-5.632-7.178-8.529-10.746 c-11.013,4.952-21.678,10.649-31.883,17.099c1.343,4.369,2.768,8.731,4.232,13.085C108.596,62.22,94.516,73.792,81.9,86.779 c-3.965-2.282-7.857-4.653-11.895-6.821c-8.286,8.755-15.949,18.102-22.957,27.934c2.921,3.544,6.004,6.894,8.998,10.342 c-10.252,14.841-18.87,30.871-25.635,47.864c-4.54-0.574-9.096-1.108-13.652-1.578c-4.337,11.297-7.833,22.876-10.52,34.634 c4.078,2.152,8.14,4.232,12.227,6.247c-3.464,16.33-5.316,33.25-5.316,50.599c0,1.092,0.064,2.193,0.072,3.277 c-4.402,1.182-8.828,2.428-13.222,3.754c0.348,12.033,1.482,24.074,3.513,35.977c4.556,0.438,9.135,0.818,13.715,1.134 c3.318,18.045,8.594,35.41,15.65,51.837c-3.601,2.776-7.17,5.624-10.746,8.521c4.944,11.03,10.641,21.695,17.098,31.891 c4.37-1.336,8.731-2.744,13.069-4.233c9.92,15.27,21.492,29.302,34.48,41.942c-2.282,3.965-4.653,7.848-6.821,11.878 c8.747,8.303,18.101,15.974,27.934,22.974c3.544-2.937,6.886-6.012,10.325-9.006c14.841,10.252,30.888,18.878,47.881,25.643 c-0.591,4.556-1.134,9.112-1.586,13.676c11.272,4.322,22.876,7.809,34.65,10.496c2.136-4.078,4.224-8.149,6.238-12.227 c16.33,3.464,33.25,5.309,50.6,5.309c1.157,0,2.29-0.065,3.439-0.073c1.206,4.402,2.266,8.828,3.577,13.23 c12.041-0.347,24.09-1.481,35.985-3.512c0.445-4.564,0.825-9.136,1.141-13.716c18.046-3.317,35.412-8.577,51.838-15.666 c2.768,3.617,5.616,7.186,8.512,10.762c11.03-4.944,21.687-10.648,31.899-17.098c-1.335-4.362-2.743-8.731-4.232-13.085 c15.245-9.913,29.326-21.469,41.941-34.464c3.965,2.29,7.85,4.644,11.888,6.821c8.294-8.764,15.965-18.101,22.957-27.934 c-2.937-3.544-5.996-6.886-8.99-10.326c10.252-14.841,18.846-30.895,25.636-47.889c4.556,0.599,9.112,1.117,13.667,1.57 c4.321-11.248,7.801-22.86,10.504-34.626c-4.079-2.136-8.149-4.224-12.228-6.238C496.998,290.27,498.842,273.357,498.842,256z M256,410.793c-85.501,0-154.809-69.292-154.809-154.793c0-85.5,69.308-154.8,154.809-154.8c85.484,0,154.809,69.3,154.809,154.8 C410.809,341.501,341.485,410.793,256,410.793z"></path> <path class="st0" d="M256,270.962c8.262,0,14.962-6.692,14.962-14.962c0-8.27-6.7-14.97-14.962-14.97 c-8.278,0-14.978,6.7-14.978,14.97C241.022,264.27,247.722,270.962,256,270.962z"></path> <path class="st0" d="M156.136,199.687c1.044,2.808,3.31,4.977,6.15,5.907l53.367,17.342c4.968,1.602,10.406,0.752,14.623-2.323 c4.232-3.075,6.724-7.979,6.724-13.206v-56.062c0-2.994-1.376-5.826-3.714-7.671c-2.347-1.861-5.406-2.541-8.327-1.861 c0,0,0.802-0.606-4.588,1.085c-25.191,7.938-46.756,24.042-61.572,45.218c-3.035,4.354-1.861,3.107-1.861,3.107 C155.384,193.772,155.092,196.887,156.136,199.687z"></path> <path class="st0" d="M214.391,269.53c-1.61-4.977-5.51-8.877-10.463-10.479l-53.327-17.325c-2.865-0.931-5.956-0.494-8.448,1.157 c-2.5,1.659-4.094,4.369-4.329,7.347c0,0-0.34-0.946-0.388,4.71c-0.251,26.396,8.407,51.878,23.96,72.52 c3.204,4.241,2.379,2.744,2.379,2.744c1.95,2.25,4.823,3.496,7.801,3.374c2.994-0.13,5.762-1.602,7.517-4.03l32.967-45.396 C215.152,279.936,216.001,274.482,214.391,269.53z"></path> <path class="st0" d="M269.198,306.47c-3.074-4.216-7.978-6.716-13.198-6.716c-5.22,0-10.123,2.5-13.206,6.716l-32.943,45.356 c-1.764,2.42-2.314,5.51-1.513,8.399c0.818,2.889,2.889,5.228,5.656,6.393c0,0-1.011,0.025,4.346,1.82 c25.044,8.392,51.951,8.028,76.388-0.396c5.025-1.724,3.334-1.4,3.334-1.4c2.752-1.158,4.823-3.512,5.616-6.385 c0.817-2.889,0.251-5.98-1.506-8.392L269.198,306.47z"></path> <path class="st0" d="M361.448,241.709l-53.375,17.342c-4.952,1.602-8.853,5.502-10.471,10.479 c-1.611,4.953-0.752,10.407,2.323,14.614l32.958,45.356c1.748,2.436,4.515,3.893,7.509,4.038c2.995,0.122,5.868-1.141,7.826-3.406 c0,0-0.283,0.963,3.084-3.576c15.706-21.218,23.685-46.934,23.224-72.764c-0.089-5.3-0.307-3.593-0.307-3.593 c-0.235-2.986-1.846-5.697-4.338-7.348C367.395,241.216,364.28,240.779,361.448,241.709z"></path> <path class="st0" d="M281.708,220.613c4.233,3.059,9.67,3.924,14.63,2.323l53.327-17.342c2.848-0.922,5.114-3.099,6.15-5.907 c1.036-2.8,0.744-5.923-0.818-8.488c0,0,0.834,0.567-2.452-4.03c-15.318-21.508-37.288-37.038-62.025-44.596 c-5.065-1.537-3.528-0.809-3.528-0.809c-2.905-0.68-5.956,0.008-8.31,1.877c-2.331,1.837-3.69,4.669-3.69,7.656v56.11 C274.984,212.634,277.492,217.538,281.708,220.613z"></path> </g> </g><
                                /svg>     
                             </span>
                             </div>
                        <table class="min-w-full divide-y divide-gray-200"> <colgroup> <col style="width: 30%;">
                                <col style="width: 30%;">
                                <col style="width: 40%;">
                            </colgroup>
                            <thead class="player-status-header">
                                <tr>
                                    <th scope="col">Player</th>
                                    <th scope="col" class="text-center">Status</th>
                                    <th scope="col" class="text-center">Attendance</th>
                                </tr>
                            </thead>
                            <tbody id="player-list" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="3" class="text-center py-4 text-gray-500">Loading players...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="info-panel lg:col-span-1">
                         <h3 class="text-xl font-semibold">Schedule & Info</h3>
                         <p><strong>Confirmation Deadline:</strong> 21:00</p>
                         <p><strong>Team Setup:</strong> 21:15 - 21:45</p>
                         <p><strong>Be Online By:</strong> 21:45</p>
                         <p><strong>Match Start:</strong> 22:00</p>
                         <hr class="border-gray-200 my-4">
                         <h4 class="text-lg font-semibold mb-2 text-blue-600">Drafting Rules</h4>
                         <ul class="list-disc list-inside text-sm space-y-1 text-gray-600">
                             <li>Coin toss winner chooses first pick OR gives first pick away.</li>
                             <li>Picks follow 1-2-2-2-2-1 format.</li>
                             <li>Reroll if teams seem unbalanced.</li>
                             <li>Coin toss loser picks 2nd & 3rd map bans.</li>
                             <li>Coin toss winner picks 1st map ban.</li>
                             <li>Coin toss winner chooses side on Map 1 & 3.</li>
                             <li>Coin toss loser chooses side on Map 2.</li>
                         </ul>
                    </div>
                </div>
            </div>

            <div id="page-batak_domination" class="page-content hidden page-content-container">
                <h2 class="text-2xl font-semibold text-blue-600">Batak Domination</h2>
                <div class="mt-6 flex justify-center">
                    <img src="images/BatakDom.jpg" alt="Batak Domination" class="max-w-full h-auto rounded-lg shadow-md" />
                </div>
                <div id="batak-data-content" class="mt-4"></div>
            </div>
            <div id="page-sonmac" class="page-content hidden page-content-container">
                <h2 class="text-2xl font-semibold text-blue-600 mb-4">Son Maç</h2>
                
                <!-- Map tabs navigation -->
                <div class="mb-4 border-b border-gray-200">
                    <ul id="map-tabs" class="flex flex-wrap -mb-px text-sm font-medium text-center">
                        <!-- Map tabs will be dynamically generated here -->
                    </ul>
                </div>
                
                <!-- Map tab content -->
                <div id="mapTabContent">
                    <!-- Map content will be dynamically generated here -->
                </div>
            </div>
            <div id="page-gece_ortalama" class="page-content hidden page-content-container">
                <h2 class="text-2xl font-semibold text-blue-600 mb-4">Gece Ortalaması</h2>
                <div class="overflow-x-auto">
                    <table class="styled-table min-w-full text-sm">
                        <thead>
                            <tr>
                                <th>Oyuncu</th>
                                <th>HLTV2</th>
                                <th>ADR</th>
                                <th>K/D</th>
                                <th>MVP</th>
                                <th>Kills</th>
                                <th>Deaths</th>
                                <th>Assists</th>
                                <th>HS</th>
                                <th>HS/Kill ratio</th>
                                <th>First Kill</th>
                                <th>First Death</th>
                                <th>Bomb Planted</th>
                                <th>Bomb Defused</th>
                                <th>HLTV</th>
                                <th>KAST</th>
                                <th>Utility Damage</th>
                                <th>2 kills</th>
                                <th>3 kills</th>
                                <th>4 kills</th>
                                <th>5 kills</th>
                                <th>Nr of Matches</th>
                                <th>WIN RATE (%)</th>
                                <th>Nr of clutches per game</th>
                                <th>Clutches Won</th>
                                <th>Successful Clutch (%)</th>
                            </tr>
                        </thead>
                        <tbody id="night-avg-table-body">
                            <!-- Data rows will be injected here by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div id="page-last10" class="page-content hidden page-content-container">
                <h2 class="text-2xl font-semibold text-blue-600 mb-4">Son 10 Ortalaması</h2>
                <div class="overflow-x-auto">
                    <table class="styled-table min-w-full text-sm">
                        <thead>
                            <tr>
                                <th>Oyuncu</th>
                                <th>HLTV2</th>
                                <th>ADR</th>
                                <th>K/D</th>
                                <th>MVP</th>
                                <th>Kills</th>
                                <th>Deaths</th>
                                <th>Assists</th>
                                <th>HS</th>
                                <th>HS/Kill ratio</th>
                                <th>First Kill</th>
                                <th>First Death</th>
                                <th>Bomb Planted</th>
                                <th>Bomb Defused</th>
                                <th>HLTV</th>
                                <th>KAST</th>
                                <th>Utility Damage</th>
                                <th>2 kills</th>
                                <th>3 kills</th>
                                <th>4 kills</th>
                                <th>5 kills</th>
                                <th>Nr of Matches</th>
                                <th>WIN RATE (%)</th>
                                <th>Nr of clutches per game</th>
                                <th>Clutches Won</th>
                                <th>Successful Clutch (%)</th>
                            </tr>
                        </thead>
                        <tbody id="last10-table-body">
                            <!-- Data rows will be injected here by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div id="page-season_avg" class="page-content hidden page-content-container">
                <h2 class="text-2xl font-semibold text-blue-600 mb-4">Sezon Ortalaması</h2>
                <div class="overflow-x-auto">
                    <table class="styled-table min-w-full text-sm">
                        <thead>
                            <tr>
                                <th>Oyuncu</th>
                                <th>HLTV2</th>
                                <th>ADR</th>
                                <th>K/D</th>
                                <th>MVP</th>
                                <th>Kills</th>
                                <th>Deaths</th>
                                <th>Assists</th>
                                <th>HS</th>
                                <th>HS/Kill ratio</th>
                                <th>First Kill</th>
                                <th>First Death</th>
                                <th>Bomb Planted</th>
                                <th>Bomb Defused</th>
                                <th>HLTV</th>
                                <th>KAST</th>
                                <th>Utility Damage</th>
                                <th>2 kills</th>
                                <th>3 kills</th>
                                <th>4 kills</th>
                                <th>5 kills</th>
                                <th>Nr of Matches</th>
                                <th>WIN RATE (%)</th>
                                <th>Nr of clutches per game</th>
                                <th>Clutches Won</th>
                                <th>Successful Clutch (%)</th>
                            </tr>
                        </thead>
                        <tbody id="season-avg-table-body">
                            <!-- Data rows will be injected here by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

        </div> </div>

    <script>
        // --- Constants ---
        const APPS_SCRIPT_URL = 'https://royal-flower-aa89.onur1atak.workers.dev/'; // Replace with your actual URL
        const ATTENDANCE_STATES = ["not_coming", "no_response", "coming"]; // Order matters for cycling
        const DEFAULT_PAGE = 'season_avg';
        const TEKER_DONDU_THRESHOLD = 10; // Number of players needed for the wheel
        const SEASON_AVG_JSON_URL = 'data/season_avg.json';
        const LAST10_JSON_URL = 'data/last10.json';
        const NIGHT_AVG_JSON_URL = 'data/night_avg.json';
        const SONMAC_JSON_URL = 'data/sonmac.json';

        // --- State ---
        let players = []; // Initialize empty, will be filled by fetch
        let currentTimeoutId = null; // To manage message timeout

        // --- DOM Elements ---
        const playerListBody = document.getElementById('player-list');
        const pageContentArea = document.getElementById('page-content-area');
        const updateButton = document.getElementById('update-stats-button');
        const messageArea = document.getElementById('message-area');
        const spinner = document.getElementById('spinner');
        // Updated summary elements
        const attendanceSummaryDiv = document.getElementById('attendance-summary');
        const summaryTextSpan = document.getElementById('summary-text');
        const tekerDonduIndicator = document.getElementById('teker-dondu-indicator');
        // Nav elements
        const menuButton = document.getElementById('menu-button');
        const navLinksContainer = document.getElementById('main-nav-links');
        const navLinks = navLinksContainer.querySelectorAll('.tab-nav-item');
        const iconHamburger = document.getElementById('icon-hamburger');
        const iconClose = document.getElementById('icon-close');

        // --- Helper Functions ---

        /**
         * Displays a message to the user (success or error).
         * @param {string} text - The message text.
         * @param {'success' | 'error'} type - The type of message.
         * @param {number} duration - How long to show the message in ms.
         */
        function showMessage(text, type = 'error', duration = 5000) {
            // Clear previous timeout if exists
            if (currentTimeoutId) {
                clearTimeout(currentTimeoutId);
            }

            messageArea.textContent = text;
            // Reset classes, keeping base ones if needed (like hidden initially)
            messageArea.className = 'hidden'; // Start hidden
            messageArea.classList.add(type); // Add 'success' or 'error' class
            messageArea.classList.remove('hidden'); // Make visible

            // Set timeout to hide the message
            currentTimeoutId = setTimeout(() => {
                messageArea.classList.add('hidden');
                messageArea.classList.remove(type);
                currentTimeoutId = null; // Reset timeout ID
            }, duration);
        }

        /**
         * Renders the player list in the table and updates the summary.
         */
        function renderPlayers() {
            // Ensure required DOM elements exist
            if (!playerListBody || !attendanceSummaryDiv || !summaryTextSpan || !tekerDonduIndicator) {
                console.error("Required DOM elements for rendering players/summary are missing.");
                return;
            }
            playerListBody.innerHTML = ''; // Clear existing rows

            // Define default summary state
            let summaryBgClass = 'bg-red-100';
            let summaryTextClass = 'text-red-800';
            let wheelColorClass = 'text-red-800'; // Match wheel color to text

            // Handle case where player data is not available
            if (players.length === 0) {
                 playerListBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">No player data available. Try updating.</td></tr>';
                 summaryTextSpan.textContent = 'Gelen oyuncu: 0  Belirsiz: 0';
                 tekerDonduIndicator.classList.add('hidden'); // Ensure indicator is hidden
            } else {
                // Calculate counts
                let countComing = 0;
                let countNoResponse = 0;
                players.forEach(player => {
                    if (player.attendance === 'coming') countComing++;
                    if (player.attendance === 'no_response') countNoResponse++;
                });

                // Update summary text
                summaryTextSpan.textContent = `Gelen oyuncu: ${countComing}  Belirsiz: ${countNoResponse}`;

                // Determine background/text colors and Show/hide the "Teker Döndü" indicator
                if (countComing >= TEKER_DONDU_THRESHOLD) {
                    summaryBgClass = 'bg-green-100';
                    summaryTextClass = 'text-green-800';
                    wheelColorClass = 'text-green-800'; // Match wheel color
                    tekerDonduIndicator.classList.remove('hidden');
                } else {
                    // Keep default red colors defined above
                    tekerDonduIndicator.classList.add('hidden');
                }
            }

            // Apply summary styles
            // Remove potentially existing color classes first
            attendanceSummaryDiv.classList.remove('bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'text-gray-700');
            tekerDonduIndicator.classList.remove('text-green-800', 'text-red-800', 'text-gray-600'); // Remove potential wheel colors

            // Add the determined classes
            attendanceSummaryDiv.classList.add(summaryBgClass, summaryTextClass);
            if (!tekerDonduIndicator.classList.contains('hidden')) {
                 tekerDonduIndicator.classList.add(wheelColorClass);
            }


            // Define attendance state configurations (styles and text)
            const stateConfigs = {
                coming: { text: 'Geliyor', bgColor: 'bg-green-500', textColor: 'text-white' },
                not_coming: { text: 'Gelmiyor', bgColor: 'bg-red-500', textColor: 'text-white' },
                no_response: { text: 'Belirsiz', bgColor: 'bg-gray-300', textColor: 'text-gray-900' }
            };

            // Create and append rows for each player (only if players exist)
            if (players.length > 0) {
                players.forEach((player) => {
                    const row = document.createElement('tr');
                    row.setAttribute('data-player-name', player.name);

                    // 1) Name cell
                    const nameCell = document.createElement('td');
                    nameCell.className = 'font-medium text-gray-900 whitespace-nowrap'; // Keep nowrap on larger screens
                    nameCell.textContent = player.name;
                    row.appendChild(nameCell);

                    // 2) Status cell
                    const statusCell = document.createElement('td');
                    const statusBadge = document.createElement('span');
                    // *** Use rounded-md and ensure status-badge class is present ***
                    statusBadge.className = 'status-badge px-2 py-1 text-xs font-medium rounded-md'; // Changed to rounded-md

                    // --- Status Text Logic ---
                    let displayStatus = 'Unknown'; // Default display text
                    const originalStatus = (player.status || '').toLowerCase(); // Get original status safely

                    if (originalStatus.includes('aktif')) {
                        displayStatus = 'Aktif Oyuncu'; // Simplified active text
                    } else if (originalStatus === 'adam evde yok') {
                        displayStatus = 'Evde Yok'; // Simplified inactive text as requested
                    } else if (player.status) {
                        displayStatus = player.status; // Use original if not recognized but exists
                    }
                    statusBadge.textContent = displayStatus;
                    // --- End Status Text Logic ---


                    // Color-code the status badge based on the *original* status logic
                    if (originalStatus.includes('aktif')) {
                        statusBadge.classList.add('bg-green-100', 'text-green-800');
                    } else if (originalStatus === 'adam evde yok' || originalStatus.includes('inactive')) { // Check original logic conditions
                        statusBadge.classList.add('bg-red-100', 'text-red-800');
                    } else {
                        statusBadge.classList.add('bg-gray-100', 'text-gray-800'); // Default/Unknown style
                    }
                    statusCell.appendChild(statusBadge);
                    row.appendChild(statusCell);

                    // 3) Attendance cell (using the improved control)
                    const attendanceCell = document.createElement('td');
                    attendanceCell.className = 'text-center'; // Center content within the cell

                    const currentState = player.attendance || 'no_response';
                    const config = stateConfigs[currentState];

                    // Container for the control
                    const container = document.createElement('div');
                    container.className = 'attendance-control-container'; // Centered flex container

                    // Left arrow button (using SVG)
                    const leftArrowBtn = document.createElement('button');
                    leftArrowBtn.className = 'attendance-arrow';
                    leftArrowBtn.setAttribute('aria-label', `Previous status for ${player.name}`);
                    leftArrowBtn.setAttribute('data-direction', 'left');
                    leftArrowBtn.setAttribute('data-player', player.name);
                    leftArrowBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg>`; // Left chevron SVG

                    // Status pill label - Apply fixed width via inline style or Tailwind arbitrary value class
                    const labelSpan = document.createElement('span');
                    // Apply base classes and dynamic background/text color
                    labelSpan.className = `attendance-label ${config.bgColor} ${config.textColor}`;
                    // Add fixed width style directly (alternative: use w-[76px] in className)
                    // labelSpan.style.width = '76px'; // Apply fixed width directly
                    labelSpan.textContent = config.text;
                    labelSpan.setAttribute('data-state', currentState); // Store current state
                    labelSpan.setAttribute('data-player', player.name); // Link to player

                    // Right arrow button (using SVG)
                    const rightArrowBtn = document.createElement('button');
                    rightArrowBtn.className = 'attendance-arrow';
                    rightArrowBtn.setAttribute('aria-label', `Next status for ${player.name}`);
                    rightArrowBtn.setAttribute('data-direction', 'right');
                    rightArrowBtn.setAttribute('data-player', player.name);
                    rightArrowBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>`; // Right chevron SVG

                    // Append elements to the container
                    container.appendChild(leftArrowBtn);
                    container.appendChild(labelSpan);
                    container.appendChild(rightArrowBtn);

                    // Append the container to the cell
                    attendanceCell.appendChild(container);
                    row.appendChild(attendanceCell);

                    // Add the row to the table body
                    playerListBody.appendChild(row);
                });
            } // End player loop
        }

        /**
         * Fetches attendance data from the Google Apps Script endpoint.
         */
        async function fetchStatsFromSheet() {
            spinner.classList.remove('hidden');
            updateButton.disabled = true;
            try {
                const response = await fetch(APPS_SCRIPT_URL);
                if (!response.ok) {
                    // Try to get more specific error from response body if possible
                    let errorDetails = `HTTP error! Status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorDetails += ` - ${errorData.message || JSON.stringify(errorData)}`;
                    } catch (e) { /* Ignore if response is not JSON */ }
                    throw new Error(errorDetails);
                }
                const data = await response.json();
                // Basic validation: Check if it's an array
                if (!Array.isArray(data)) {
                    console.error("Received data is not an array:", data);
                    throw new Error("Invalid data format received from server.");
                }
                players = data; // Update the global players array
                renderPlayers(); // Re-render the table with new data
                //showMessage('Attendance data loaded successfully!', 'success');
            } catch (err) {
                console.error('Failed to fetch stats:', err);
                showMessage(`Error loading data: ${err.message}`, 'error');
                // Optionally render with empty state or keep old data
                 renderPlayers(); // Render even on error to show empty state or previous data
            } finally {
                spinner.classList.add('hidden');
                updateButton.disabled = false;
            }
        }

        /**
         * Sends an attendance update for a specific player to the Google Apps Script endpoint.
         * @param {string} playerName - The name of the player to update.
         * @param {string} newAttendance - The new attendance status ('coming', 'not_coming', 'no_response').
         */
        async function updateAttendanceInSheet(playerName, newAttendance) {
            // Optional: Add visual feedback (e.g., temporary spinner on the row)
            console.log(`Attempting to update ${playerName} to ${newAttendance}`);
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    // Use 'no-cors' if your Apps Script is not configured for CORS preflight (simple requests)
                    // mode: 'no-cors', // Uncomment if needed, but you won't get response details back
                    headers: {
                        // 'Content-Type': 'application/json' // Needed for standard CORS
                        'Content-Type': 'text/plain;charset=utf-8', // Often needed for simple 'no-cors' POST to Apps Script
                    },
                    // Body needs to be stringified for application/json or simple text for text/plain
                     body: JSON.stringify({ name: playerName, attendance: newAttendance }),
                    // Example for text/plain if Apps Script expects that:
                    // body: `name=${encodeURIComponent(playerName)}&attendance=${encodeURIComponent(newAttendance)}`
                });

                // Note: With 'no-cors', response.ok will likely be false even on success.
                // You might need to rely on the absence of network errors.
                // If using standard CORS (recommended):
                 if (!response.ok) {
                     let errorText = `Network response was not ok (Status: ${response.status})`;
                     try {
                        // Try to parse error response if server sends JSON errors
                        const errorData = await response.json();
                        errorText += `: ${errorData.message || JSON.stringify(errorData)}`;
                     } catch(e) {
                        // Fallback if error response isn't JSON
                        errorText = await response.text();
                     }
                     throw new Error(errorText);
                 }
                 // If using standard CORS and expecting JSON response:
                 // const result = await response.json();
                 // console.log('Update successful:', result);

                console.log(`Attendance updated successfully in sheet for ${playerName} to ${newAttendance}`);
                // Optional: Show temporary success message
                // showMessage(`${playerName}'s status updated!`, 'success', 2000);

            } catch (error) {
                console.error('Failed to update attendance in sheet:', error);
                showMessage(`Failed to update status for ${playerName}: ${error.message}`, 'error');
                // OPTIONAL: Revert the UI change if the update fails
                // To do this, you'd need to store the *previous* state before the optimistic update
                // and call fetchStatsFromSheet() or manually revert the specific player's state and re-render.
                // Example (simple refetch):
                // showMessage(`Update failed for ${playerName}. Reverting...`, 'error');
                // await fetchStatsFromSheet(); // Refetch to get the actual state from the sheet
            } finally {
                 // Optional: Remove row-specific spinner if added
            }
        }


        /**
         * Handles clicks within the player list table, specifically for attendance changes.
         * Uses event delegation. Detects clicks on arrows OR the label itself.
         * @param {Event} event - The click event object.
         */
        async function handlePlayerListClick(event) {
            const targetArrow = event.target.closest('.attendance-arrow');
            const targetLabel = event.target.closest('.attendance-label');
            let playerName = null;
            let direction = null; // 'left', 'right', or null if label clicked
            let playerIndex = -1;
            let isLabelClick = false;

            if (targetArrow) {
                // Clicked on an arrow button
                playerName = targetArrow.getAttribute('data-player');
                direction = targetArrow.getAttribute('data-direction');
            } else if (targetLabel) {
                 // Clicked directly on the label pill
                 isLabelClick = true;
                 playerName = targetLabel.getAttribute('data-player');
                 // Determine direction based on click position
                 const rect = targetLabel.getBoundingClientRect();
                 const clickX = event.clientX - rect.left; // X position within the element
                 direction = (clickX < rect.width / 2) ? 'left' : 'right'; // Left half or right half
            }

            if (playerName) {
                playerIndex = players.findIndex(p => p.name === playerName);
            }

            if (playerIndex > -1 && direction) {
                // Common logic for both arrow and label clicks
                const currentState = players[playerIndex].attendance || 'no_response';
                let currentIndex = ATTENDANCE_STATES.indexOf(currentState);

                // Calculate the new index based on direction
                if (direction === 'left') {
                    currentIndex = (currentIndex - 1 + ATTENDANCE_STATES.length) % ATTENDANCE_STATES.length;
                } else { // 'right'
                    currentIndex = (currentIndex + 1) % ATTENDANCE_STATES.length;
                }

                const newState = ATTENDANCE_STATES[currentIndex];

                // Optimistic UI Update
                players[playerIndex].attendance = newState;
                renderPlayers(); // Update the UI

                // Asynchronously update the backend
                await updateAttendanceInSheet(playerName, newState);
            } else if (playerName && !direction) {
                 console.warn(`Could not determine click direction for player ${playerName}`);
            } else if (targetArrow || targetLabel) {
                 console.warn(`Player data not found for clicked element.`);
            }
            // If click was not on an arrow or label, do nothing.
        }


        // --- Navigation Logic ---

        /**
         * Shows the specified page content and updates navigation link styles.
         * @param {string} pageId - The ID of the page to show (e.g., 'attendance', 'draft').
         */
        function showPage(pageId) {
            const allPages = pageContentArea.querySelectorAll('.page-content');
            allPages.forEach(page => {
                page.classList.add('hidden'); // Hide all pages
            });

            const targetPage = document.getElementById(`page-${pageId}`);
            if (targetPage) {
                targetPage.classList.remove('hidden'); // Show the target page
            } else {
                console.error(`Page content with ID 'page-${pageId}' not found.`);
                // Optionally show a default page or an error message
                document.getElementById(`page-${DEFAULT_PAGE}`)?.classList.remove('hidden');
                pageId = DEFAULT_PAGE; // Fallback to default
            }

            // Update navigation link active states
            navLinks.forEach(link => {
                link.classList.remove('active');
                // Remove mobile-specific active styles if they exist
                link.classList.remove('bg-blue-50', 'border-l-blue-500', 'text-blue-600'); // More specific removal

                if (link.getAttribute('data-page') === pageId) {
                    link.classList.add('active'); // Add active class to the correct link
                    // Apply mobile-specific active styles if the menu is currently in mobile view
                    if (navLinksContainer.classList.contains('mobile-menu-active')) {
                         link.classList.add('bg-eff6ff', 'border-l-blue-600', 'text-blue-600'); // Use actual color codes if needed
                    }
                }
            });

            // If switching to attendance page, ensure players are rendered (might be redundant if already rendered)
            // if (pageId === 'attendance') {
            //     renderPlayers();
            // }

             // Close mobile menu after selecting an item (optional but good UX)
             if (navLinksContainer.classList.contains('mobile-menu-active')) {
                toggleMobileMenu(false); // Force close
             }
        }

        /**
         * Toggles the visibility and state of the mobile navigation menu.
         * @param {boolean} [forceState] - Optional. Force 'true' to open, 'false' to close.
         */
        function toggleMobileMenu(forceState) {
            const shouldBeOpen = forceState !== undefined ? forceState : menuButton.getAttribute('aria-expanded') === 'false';

            menuButton.setAttribute('aria-expanded', shouldBeOpen);
            iconHamburger.classList.toggle('hidden', shouldBeOpen);
            iconClose.classList.toggle('hidden', !shouldBeOpen);

            // Use Tailwind classes for visibility on mobile
            navLinksContainer.classList.toggle('hidden', !shouldBeOpen); // Hide if not open
             // Add/remove classes that define the mobile menu appearance
            navLinksContainer.classList.toggle('mobile-menu-active', shouldBeOpen);


            // Re-apply active styles correctly when opening/closing
            const activeLink = navLinksContainer.querySelector('.tab-nav-item.active');
            if (activeLink) {
                // Remove potentially incorrect mobile styles first
                activeLink.classList.remove('bg-eff6ff', 'border-l-blue-600', 'text-blue-600');
                if (shouldBeOpen) {
                    // Add mobile active styles only if opening
                     activeLink.classList.add('bg-eff6ff', 'border-l-blue-600', 'text-blue-600');
                }
            }
        }

        /**
         * Fetches season average player stats from the local JSON file.
         */
        async function fetchSeasonAvgStats() {
            try {
                const response = await fetch(SEASON_AVG_JSON_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();
                if (!Array.isArray(data)) {
                    throw new Error("Invalid data format received from JSON file.");
                }
                return data;
            } catch (err) {
                console.error('Failed to fetch season avg stats:', err);
                showMessage(`Error loading season stats: ${err.message}`, 'error');
                return [];
            }
        }

        // Example usage: fetch and render
        async function loadAndRenderSeasonAvgTable() {
            const stats = await fetchSeasonAvgStats();
            if (stats.length > 0) {
                fillSeasonAvgTable(stats);
            }
        }

        // Modify fillSeasonAvgTable to accept data as a parameter:
        function fillSeasonAvgTable(data) {
            // --- Calculate min/max for rating columns ---
            const hltv2Vals = data.map(d => d.hltv_2).filter(v => typeof v === 'number');
            const adrVals = data.map(d => d.adr).filter(v => typeof v === 'number');
            const kdVals = data.map(d => d.kd).filter(v => typeof v === 'number');

            // Ensure we have valid numbers before calculating min/max
            const minHLTV2 = hltv2Vals.length > 0 ? Math.min(...hltv2Vals) : 0;
            const maxHLTV2 = hltv2Vals.length > 0 ? Math.max(...hltv2Vals) : 1; // Avoid div by zero if only one value
            const minADR = adrVals.length > 0 ? Math.min(...adrVals) : 0;
            const maxADR = adrVals.length > 0 ? Math.max(...adrVals) : 1;
            const minKD = kdVals.length > 0 ? Math.min(...kdVals) : 0;
            const maxKD = kdVals.length > 0 ? Math.max(...kdVals) : 1;

            // Helper: Get CSS badge class based on value and range
            function getBadgeClass(val, min, max) {
                if (max === min) return 'badge-average'; // Handle cases with single player or all same values
                const percent = (val - min) / (max - min);

                if (percent >= 0.95) return 'badge-super-elite'; // Red
                if (percent >= 0.85) return 'badge-elite';       // Orange
                if (percent >= 0.70) return 'badge-very-good';   // Info Blue
                if (percent >= 0.55) return 'badge-good';        // Green
                if (percent >= 0.45) return 'badge-average';     // Grey
                if (percent >= 0.30) return 'badge-below-average';// Steel Blue
                return 'badge-poor';                             // Dark Grey
            }

            // --- Sort by HLTV2 descending ---
            data.sort((a, b) => (b.hltv_2 ?? 0) - (a.hltv_2 ?? 0)); // Handle potential null/undefined

            const tbody = document.getElementById('season-avg-table-body');
            tbody.innerHTML = ''; // Clear existing rows

            data.forEach(row => {
                // Helper to safely format numbers or return 'N/A'
                const formatNum = (num, decimals = 2) => (typeof num === 'number' ? num.toFixed(decimals) : 'N/A');
                const formatPercent = (num) => (typeof num === 'number' ? num.toFixed(2) + '%' : 'N/A');

                const tr = document.createElement('tr');
                // Apply CSS badge classes using spans inside stat-badge-cell
                tr.innerHTML = `
                    <td class="font-medium text-gray-900 whitespace-nowrap">${row.name || 'N/A'}</td>
                    <td class="stat-badge-cell"><span class="${getBadgeClass(row.hltv_2, minHLTV2, maxHLTV2)}">${formatNum(row.hltv_2)}</span></td>
                    <td class="stat-badge-cell"><span class="${getBadgeClass(row.adr, minADR, maxADR)}">${formatNum(row.adr, 0)}</span></td>
                    <td class="stat-badge-cell"><span class="${getBadgeClass(row.kd, minKD, maxKD)}">${formatNum(row.kd)}</span></td>
                    <td class="text-center">${formatNum(row.mvp)}</td>
                    <td class="text-center">${formatNum(row.kills)}</td>
                    <td class="text-center">${formatNum(row.deaths)}</td>
                    <td class="text-center">${formatNum(row.assists)}</td>
                    <td class="text-center">${formatNum(row.hs)}</td>
                    <td class="text-center">${formatPercent(row.hs_ratio)}</td>
                    <td class="text-center">${formatNum(row.first_kill)}</td>
                    <td class="text-center">${formatNum(row.first_death)}</td>
                    <td class="text-center">${formatNum(row.bomb_planted)}</td>
                    <td class="text-center">${formatNum(row.bomb_defused)}</td>
                    <td class="text-center">${formatNum(row.hltv)}</td>
                    <td class="text-center">${formatPercent(row.kast)}</td>
                    <td class="text-center">${formatNum(row.utl_dmg)}</td>
                    <td class="text-center">${formatNum(row.two_kills)}</td>
                    <td class="text-center">${formatNum(row.three_kills)}</td>
                    <td class="text-center">${formatNum(row.four_kills)}</td>
                    <td class="text-center">${formatNum(row.five_kills)}</td>
                    <td class="text-center">${row.matches ?? 'N/A'}</td>
                    <td class="text-center">${formatPercent(row.win_rate)}</td>
                    <td class="text-center">${formatNum(row.avg_clutches)}</td>
                    <td class="text-center">${formatNum(row.avg_clutches_won)}</td>
                    <td class="text-center">${formatPercent(row.clutch_success)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        /**
         * Fetches last 10 games player stats from the local JSON file.
         */
        async function fetchLast10Stats() {
            try {
                const response = await fetch(LAST10_JSON_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();
                if (!Array.isArray(data)) {
                    throw new Error("Invalid data format received from JSON file.");
                }
                return data;
            } catch (err) {
                console.error('Failed to fetch last 10 stats:', err);
                showMessage(`Error loading last 10 stats: ${err.message}`, 'error');
                return [];
            }
        }

        // Function to fetch and render the last 10 games data
        async function loadAndRenderLast10Table() {
            const stats = await fetchLast10Stats();
            if (stats.length > 0) {
                fillLast10Table(stats);
            }
        }

        // Function to fill the last 10 table with data
        function fillLast10Table(data) {
            // --- Calculate min/max for rating columns ---
            const hltv2Vals = data.map(d => d.hltv_2).filter(v => typeof v === 'number');
            const adrVals = data.map(d => d.adr).filter(v => typeof v === 'number');
            const kdVals = data.map(d => d.kd).filter(v => typeof v === 'number');

            // Ensure we have valid numbers before calculating min/max
            const minHLTV2 = hltv2Vals.length > 0 ? Math.min(...hltv2Vals) : 0;
            const maxHLTV2 = hltv2Vals.length > 0 ? Math.max(...hltv2Vals) : 1; // Avoid div by zero if only one value
            const minADR = adrVals.length > 0 ? Math.min(...adrVals) : 0;
            const maxADR = adrVals.length > 0 ? Math.max(...adrVals) : 1;
            const minKD = kdVals.length > 0 ? Math.min(...kdVals) : 0;
            const maxKD = kdVals.length > 0 ? Math.max(...kdVals) : 1;

            // Helper: Get CSS badge class based on value and range
            function getBadgeClass(val, min, max) {
                if (max === min) return 'badge-average'; // Handle cases with single player or all same values
                const percent = (val - min) / (max - min);

                if (percent >= 0.95) return 'badge-super-elite'; // Red
                if (percent >= 0.85) return 'badge-elite';       // Orange
                if (percent >= 0.70) return 'badge-very-good';   // Info Blue
                if (percent >= 0.55) return 'badge-good';        // Green
                if (percent >= 0.45) return 'badge-average';     // Grey
                if (percent >= 0.30) return 'badge-below-average';// Steel Blue
                return 'badge-poor';                             // Dark Grey
            }

            // --- Sort by HLTV2 descending ---
            data.sort((a, b) => (b.hltv_2 ?? 0) - (a.hltv_2 ?? 0)); // Handle potential null/undefined

            const tbody = document.getElementById('last10-table-body');
            tbody.innerHTML = ''; // Clear existing rows

            data.forEach(row => {
                // Helper to safely format numbers or return 'N/A'
                const formatNum = (num, decimals = 2) => (typeof num === 'number' ? num.toFixed(decimals) : 'N/A');
                const formatPercent = (num) => (typeof num === 'number' ? num.toFixed(2) + '%' : 'N/A');

                const tr = document.createElement('tr');
                // Apply CSS badge classes using spans inside stat-badge-cell
                tr.innerHTML = `
                    <td class="font-medium text-gray-900 whitespace-nowrap">${row.name || 'N/A'}</td>
                    <td class="stat-badge-cell"><span class="${getBadgeClass(row.hltv_2, minHLTV2, maxHLTV2)}">${formatNum(row.hltv_2)}</span></td>
                    <td class="stat-badge-cell"><span class="${getBadgeClass(row.adr, minADR, maxADR)}">${formatNum(row.adr, 0)}</span></td>
                    <td class="stat-badge-cell"><span class="${getBadgeClass(row.kd, minKD, maxKD)}">${formatNum(row.kd)}</span></td>
                    <td class="text-center">${formatNum(row.mvp)}</td>
                    <td class="text-center">${formatNum(row.kills)}</td>
                    <td class="text-center">${formatNum(row.deaths)}</td>
                    <td class="text-center">${formatNum(row.assists)}</td>
                    <td class="text-center">${formatNum(row.hs)}</td>
                    <td class="text-center">${formatPercent(row.hs_ratio)}</td>
                    <td class="text-center">${formatNum(row.first_kill)}</td>
                    <td class="text-center">${formatNum(row.first_death)}</td>
                    <td class="text-center">${formatNum(row.bomb_planted)}</td>
                    <td class="text-center">${formatNum(row.bomb_defused)}</td>
                    <td class="text-center">${formatNum(row.hltv)}</td>
                    <td class="text-center">${formatPercent(row.kast)}</td>
                    <td class="text-center">${formatNum(row.utl_dmg)}</td>
                    <td class="text-center">${formatNum(row.two_kills)}</td>
                    <td class="text-center">${formatNum(row.three_kills)}</td>
                    <td class="text-center">${formatNum(row.four_kills)}</td>
                    <td class="text-center">${formatNum(row.five_kills)}</td>
                    <td class="text-center">${row.matches ?? 'N/A'}</td>
                    <td class="text-center">${formatPercent(row.win_rate)}</td>
                    <td class="text-center">${formatNum(row.avg_clutches)}</td>
                    <td class="text-center">${formatNum(row.avg_clutches_won)}</td>
                    <td class="text-center">${formatPercent(row.clutch_success)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        /**
         * Fetches nightly average player stats from the local JSON file.
         */
        async function fetchNightAvgStats() {
            try {
                const response = await fetch(NIGHT_AVG_JSON_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();
                if (!Array.isArray(data)) {
                    throw new Error("Invalid data format received from JSON file.");
                }
                return data;
            } catch (err) {
                console.error('Failed to fetch night avg stats:', err);
                showMessage(`Error loading night stats: ${err.message}`, 'error');
                return [];
            }
        }

        // Function to fetch and render the nightly average data
        async function loadAndRenderNightAvgTable() {
            const stats = await fetchNightAvgStats();
            if (stats.length > 0) {
                fillNightAvgTable(stats);
            }
        }

        // Function to fill the nightly average table with data
        function fillNightAvgTable(data) {
            // --- Calculate min/max for rating columns ---
            const hltv2Vals = data.map(d => d.hltv_2).filter(v => typeof v === 'number');
            const adrVals = data.map(d => d.adr).filter(v => typeof v === 'number');
            const kdVals = data.map(d => d.kd).filter(v => typeof v === 'number');

            // Ensure we have valid numbers before calculating min/max
            const minHLTV2 = hltv2Vals.length > 0 ? Math.min(...hltv2Vals) : 0;
            const maxHLTV2 = hltv2Vals.length > 0 ? Math.max(...hltv2Vals) : 1; // Avoid div by zero if only one value
            const minADR = adrVals.length > 0 ? Math.min(...adrVals) : 0;
            const maxADR = adrVals.length > 0 ? Math.max(...adrVals) : 1;
            const minKD = kdVals.length > 0 ? Math.min(...kdVals) : 0;
            const maxKD = kdVals.length > 0 ? Math.max(...kdVals) : 1;

            // Helper: Get CSS badge class based on value and range
            function getBadgeClass(val, min, max) {
                if (max === min) return 'badge-average'; // Handle cases with single player or all same values
                const percent = (val - min) / (max - min);

                if (percent >= 0.95) return 'badge-super-elite'; // Red
                if (percent >= 0.85) return 'badge-elite';       // Orange
                if (percent >= 0.70) return 'badge-very-good';   // Info Blue
                if (percent >= 0.55) return 'badge-good';        // Green
                if (percent >= 0.45) return 'badge-average';     // Grey
                if (percent >= 0.30) return 'badge-below-average';// Steel Blue
                return 'badge-poor';                             // Dark Grey
            }

            // --- Sort by HLTV2 descending ---
            data.sort((a, b) => (b.hltv_2 ?? 0) - (a.hltv_2 ?? 0)); // Handle potential null/undefined

            const tbody = document.getElementById('night-avg-table-body');
            tbody.innerHTML = ''; // Clear existing rows

            data.forEach(row => {
                // Helper to safely format numbers or return 'N/A'
                const formatNum = (num, decimals = 2) => (typeof num === 'number' ? num.toFixed(decimals) : 'N/A');
                const formatPercent = (num) => (typeof num === 'number' ? num.toFixed(2) + '%' : 'N/A');

                const tr = document.createElement('tr');
                // Apply CSS badge classes using spans inside stat-badge-cell
                tr.innerHTML = `
                    <td class="font-medium text-gray-900 whitespace-nowrap">${row.name || 'N/A'}</td>
                    <td class="stat-badge-cell"><span class="${getBadgeClass(row.hltv_2, minHLTV2, maxHLTV2)}">${formatNum(row.hltv_2)}</span></td>
                    <td class="stat-badge-cell"><span class="${getBadgeClass(row.adr, minADR, maxADR)}">${formatNum(row.adr, 0)}</span></td>
                    <td class="stat-badge-cell"><span class="${getBadgeClass(row.kd, minKD, maxKD)}">${formatNum(row.kd)}</span></td>
                    <td class="text-center">${formatNum(row.mvp)}</td>
                    <td class="text-center">${formatNum(row.kills)}</td>
                    <td class="text-center">${formatNum(row.deaths)}</td>
                    <td class="text-center">${formatNum(row.assists)}</td>
                    <td class="text-center">${formatNum(row.hs)}</td>
                    <td class="text-center">${formatPercent(row.hs_ratio)}</td>
                    <td class="text-center">${formatNum(row.first_kill)}</td>
                    <td class="text-center">${formatNum(row.first_death)}</td>
                    <td class="text-center">${formatNum(row.bomb_planted)}</td>
                    <td class="text-center">${formatNum(row.bomb_defused)}</td>
                    <td class="text-center">${formatNum(row.hltv)}</td>
                    <td class="text-center">${formatPercent(row.kast)}</td>
                    <td class="text-center">${formatNum(row.utl_dmg)}</td>
                    <td class="text-center">${formatNum(row.two_kills)}</td>
                    <td class="text-center">${formatNum(row.three_kills)}</td>
                    <td class="text-center">${formatNum(row.four_kills)}</td>
                    <td class="text-center">${formatNum(row.five_kills)}</td>
                    <td class="text-center">${row.matches ?? 'N/A'}</td>
                    <td class="text-center">${formatPercent(row.win_rate)}</td>
                    <td class="text-center">${formatNum(row.avg_clutches)}</td>
                    <td class="text-center">${formatNum(row.avg_clutches_won)}</td>
                    <td class="text-center">${formatPercent(row.clutch_success)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        /**
         * Fetches Son Maç match stats from the local JSON file.
         */
        async function fetchSonMacData() {
            try {
                const response = await fetch(SONMAC_JSON_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();
                if (!data || !data.maps) {
                    throw new Error("Invalid data format received from JSON file.");
                }
                return data;
            } catch (err) {
                console.error('Failed to fetch Son Maç data:', err);
                showMessage(`Error loading Son Maç data: ${err.message}`, 'error');
                return null;
            }
        }

        // Function to fetch and render the Son Maç data
        async function loadAndRenderSonMacData() {
            const matchData = await fetchSonMacData();
            if (matchData) {
                populateSonMacData(matchData);
            }
        }

        // Function to populate the Son Maç page with match data
        function populateSonMacData(data) {
            if (!data || !data.maps) return;
            
            // Get map tabs
            const mapTabs = document.querySelector('#map-tabs');
            mapTabs.innerHTML = ''; // Clear existing tabs
            
            // Create tabs for each map
            let isFirst = true;
            Object.keys(data.maps).forEach(mapName => {
                const li = document.createElement('li');
                li.className = 'mr-2';
                li.setAttribute('role', 'presentation');
                
                const button = document.createElement('button');
                button.id = `${mapName}-tab`;
                button.className = `inline-block p-4 border-b-2 ${isFirst ? 'border-blue-500 active' : 'border-transparent'} rounded-t-lg hover:text-gray-600 hover:border-gray-300`;
                button.setAttribute('aria-controls', mapName);
                button.textContent = mapName;
                
                li.appendChild(button);
                mapTabs.appendChild(li);
                
                // Create/populate map content
                populateMapContent(mapName, data.maps[mapName], isFirst);
                
                if (isFirst) isFirst = false;
            });
            
            // Re-initialize tab functionality
            initSonMacTabs();
        }

        function populateMapContent(mapName, mapData, isActive) {
            const mapTabContent = document.getElementById('mapTabContent');
            
            // Create map div if it doesn't exist
            let mapDiv = document.getElementById(mapName);
            if (!mapDiv) {
                mapDiv = document.createElement('div');
                mapDiv.id = mapName;
                mapDiv.className = isActive ? 'active' : 'hidden';
                mapTabContent.appendChild(mapDiv);
            } else {
                mapDiv.innerHTML = ''; // Clear existing content
                mapDiv.className = isActive ? 'active' : 'hidden';
            }
            
            // Create scoreboard
            const scoreboardDiv = document.createElement('div');
            scoreboardDiv.className = 'flex justify-between items-center mb-6 px-4 py-3 bg-gray-100 rounded-lg';
            scoreboardDiv.innerHTML = `
                <div class="text-center">
                    <h3 class="text-lg font-bold">${mapData.team1.name}</h3>
                    <div class="text-3xl font-extrabold text-blue-600">${mapData.team1.score}</div>
                </div>
                <div class="text-xl font-semibold text-gray-500">vs</div>
                <div class="text-center">
                    <h3 class="text-lg font-bold">${mapData.team2.name}</h3>
                    <div class="text-3xl font-extrabold text-green-600">${mapData.team2.score}</div>
                </div>
            `;
            mapDiv.appendChild(scoreboardDiv);
            
            // Create team1 section
            const team1Div = createTeamSection(mapData.team1, 'blue');
            mapDiv.appendChild(team1Div);
            
            // Create team2 section
            const team2Div = createTeamSection(mapData.team2, 'green');
            mapDiv.appendChild(team2Div);
        }

        function createTeamSection(teamData, color) {
            const teamDiv = document.createElement('div');
            teamDiv.className = 'mb-6';
            
            // Team heading
            const teamHeading = document.createElement('h3');
            teamHeading.className = `text-lg font-semibold text-${color}-600 mb-2 px-3`;
            teamHeading.textContent = teamData.name;
            teamDiv.appendChild(teamHeading);
            
            // Table container
            const tableContainer = document.createElement('div');
            tableContainer.className = 'overflow-x-auto';
            
            // Create table
            const table = document.createElement('table');
            table.className = 'styled-table min-w-full text-sm';
            
            // Table head
            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th>Oyuncu</th>
                    <th>HLTV2</th>
                    <th>ADR</th>
                    <th>K/D</th>
                    <th>MVP</th>
                    <th>Kills</th>
                    <th>Deaths</th>
                    <th>Assists</th>
                    <th>HS</th>
                    <th>HS/Kill ratio</th>
                    <th>First Kill</th>
                    <th>First Death</th>
                    <th>Bomb Planted</th>
                    <th>Bomb Defused</th>
                    <th>HLTV</th>
                    <th>KAST</th>
                    <th>Utility Damage</th>
                    <th>2 kills</th>
                    <th>3 kills</th>
                    <th>4 kills</th>
                    <th>5 kills</th>
                    <th>Score</th>
                    <th>Nr of clutches</th>
                    <th>Clutches Won</th>
                </tr>
            `;
            table.appendChild(thead);
            
            // Table body
            const tbody = document.createElement('tbody');
            
            // Add player rows
            teamData.players.forEach(player => {
                const tr = document.createElement('tr');
                
                // Helper function for badge classes
                function getBadgeClass(val) {
                    if (val >= 1.7) return 'badge-super-elite';
                    if (val >= 1.4) return 'badge-elite';
                    if (val >= 1.2) return 'badge-very-good';
                    if (val >= 1.0) return 'badge-good';
                    if (val >= 0.85) return 'badge-average';
                    if (val >= 0.7) return 'badge-below-average';
                    return 'badge-poor';
                }
                
                // Helper to safely format numbers or return 'N/A'
                const formatNum = (num, decimals = 2) => (typeof num === 'number' ? num.toFixed(decimals) : 'N/A');
                const formatPercent = (num) => (typeof num === 'number' ? num.toFixed(2) + '%' : 'N/A');
                
                tr.innerHTML = `
                    <td class="font-medium text-gray-900 whitespace-nowrap">${player.name || 'N/A'}</td>
                    <td class="stat-badge-cell"><span class="${getBadgeClass(player.hltv_2)}">${formatNum(player.hltv_2)}</span></td>
                    <td class="stat-badge-cell"><span class="${getBadgeClass(player.adr / 100)}">${formatNum(player.adr, 0)}</span></td>
                    <td class="stat-badge-cell"><span class="${getBadgeClass(player.kd)}">${formatNum(player.kd)}</span></td>
                    <td class="text-center">${formatNum(player.mvp)}</td>
                    <td class="text-center">${formatNum(player.kills, 0)}</td>
                    <td class="text-center">${formatNum(player.deaths, 0)}</td>
                    <td class="text-center">${formatNum(player.assists, 0)}</td>
                    <td class="text-center">${formatNum(player.hs, 0)}</td>
                    <td class="text-center">${formatNum(player.hs_ratio)}</td>
                    <td class="text-center">${formatNum(player.first_kill, 0)}</td>
                    <td class="text-center">${formatNum(player.first_death, 0)}</td>
                    <td class="text-center">${formatNum(player.bomb_planted, 0)}</td>
                    <td class="text-center">${formatNum(player.bomb_defused, 0)}</td>
                    <td class="stat-badge-cell"><span class="${getBadgeClass(player.hltv)}">${formatNum(player.hltv)}</span></td>
                    <td class="text-center">${formatPercent(player.kast)}</td>
                    <td class="text-center">${formatNum(player.utl_dmg, 0)}</td>
                    <td class="text-center">${formatNum(player.two_kills, 0)}</td>
                    <td class="text-center">${formatNum(player.three_kills, 0)}</td>
                    <td class="text-center">${formatNum(player.four_kills, 0)}</td>
                    <td class="text-center">${formatNum(player.five_kills, 0)}</td>
                    <td class="text-center">${formatNum(player.score, 0)}</td>
                    <td class="text-center">${formatNum(player.clutches, 0)}</td>
                    <td class="text-center">${formatNum(player.clutches_won, 0)}</td>
                `;
                
                tbody.appendChild(tr);
            });
            
            table.appendChild(tbody);
            tableContainer.appendChild(table);
            teamDiv.appendChild(tableContainer);
            
            return teamDiv;
        }

        // --- Event Listeners ---

        // Initial load: Fetch data and show the default page
        document.addEventListener('DOMContentLoaded', () => {
            showPage(DEFAULT_PAGE); // Show the initial page
            fetchStatsFromSheet(); // Fetch initial data
            loadAndRenderSeasonAvgTable(); // Fetch and render season average stats
            loadAndRenderLast10Table(); // Fetch and render last 10 games stats
            loadAndRenderNightAvgTable(); // Fetch and render nightly average stats
            loadAndRenderSonMacData(); // Fetch and render Son Maç data
            initSonMacTabs(); // Initialize tabs for Son Maç page
            
            // Set initial navigation visibility based on screen size
            if (window.innerWidth >= 768) { // Tailwind's md breakpoint is 768px
                navLinksContainer.classList.remove('hidden', 'mobile-menu-active');
            } else {
                navLinksContainer.classList.add('hidden');
                navLinksContainer.classList.remove('mobile-menu-active');
                menuButton.setAttribute('aria-expanded', 'false');
                iconHamburger.classList.remove('hidden');
                iconClose.classList.add('hidden');
            }
        });

        // Update button click
        updateButton.addEventListener('click', fetchStatsFromSheet);

        // Player list clicks (for attendance changes via event delegation)
        playerListBody.addEventListener('click', handlePlayerListClick);

        // Navigation link clicks (using event delegation on the container)
        navLinksContainer.addEventListener('click', (event) => {
            const link = event.target.closest('.tab-nav-item');
            if (link && link.dataset.page) { // Check if it's a valid nav link with a page target
                event.preventDefault(); // Prevent default anchor link behavior
                const pageId = link.dataset.page;
                showPage(pageId);
                 // Placeholder: Fetch data for the newly selected tab if necessary
                 // loadTabDataIfNeeded(pageId);
            }
        });
        
        // --- Responsive menu fix: Ensure nav is visible on desktop after resizing from mobile ---
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 768) { // Tailwind's md breakpoint is 768px
                navLinksContainer.classList.remove('hidden', 'mobile-menu-active');
                menuButton.setAttribute('aria-expanded', 'false');
                iconHamburger.classList.remove('hidden');
                iconClose.classList.add('hidden');
            } else {
                navLinksContainer.classList.add('hidden');
                navLinksContainer.classList.remove('mobile-menu-active');
                menuButton.setAttribute('aria-expanded', 'false');
                iconHamburger.classList.remove('hidden');
                iconClose.classList.add('hidden');
            }
        });
        // Mobile menu button click
        menuButton.addEventListener('click', () => toggleMobileMenu());

        // Add JavaScript for tab functionality at the end of the script section
        // ... existing code ...

        // Add this to your DOMContentLoaded event listener or as a separate function
        function initSonMacTabs() {
            const mapTabs = document.querySelectorAll('#map-tabs button');
            const mapContents = document.querySelectorAll('#mapTabContent > div');
            
            mapTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active classes from all tabs and contents
                    mapTabs.forEach(t => {
                        t.classList.remove('active', 'border-blue-500');
                        t.classList.add('border-transparent');
                    });
                    mapContents.forEach(c => c.classList.add('hidden'));
                    
                    // Add active class to clicked tab
                    tab.classList.add('active', 'border-blue-500');
                    tab.classList.remove('border-transparent');
                    
                    // Show corresponding content
                    const contentId = tab.getAttribute('aria-controls');
                    document.getElementById(contentId).classList.remove('hidden');
                });
            });
        }

        // Modify the DOMContentLoaded event listener to initialize the Son Maç tabs
        document.addEventListener('DOMContentLoaded', () => {
            showPage(DEFAULT_PAGE); // Show the initial page
            fetchStatsFromSheet(); // Fetch initial data
            loadAndRenderSeasonAvgTable(); // Fetch and render season average stats
            loadAndRenderLast10Table(); // Fetch and render last 10 games stats
            loadAndRenderNightAvgTable(); // Fetch and render nightly average stats
            loadAndRenderSonMacData(); // Fetch and render Son Maç data
            initSonMacTabs(); // Initialize tabs for Son Maç page
            
            // Set initial navigation visibility based on screen size
            // ... existing code ...
        });
    </script>
</body>
</html>
